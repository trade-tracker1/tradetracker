<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeTracker Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --bg-color: #f8fafc;
            --text-color: #1e293b;
            --card-bg: white;
            --border-color: #e2e8f0;
            --header-bg: #ffffff;
            --primary-color: #3b82f6;
            --profit-color: #10b981;
            --loss-color: #ef4444;
            --neutral-color: #64748b;
            --prev-month-color: #94a3b8;
            --warning-color: #f59e0b;
            --info-color: #06b6d4;
        }
        
        .dark-mode {
            --bg-color: #0f172a;
            --text-color: #f1f5f9;
            --card-bg: #1e293b;
            --border-color: #334155;
            --header-bg: #1e293b;
            --primary-color: #60a5fa;
            --profit-color: #34d399;
            --loss-color: #f87171;
            --neutral-color: #94a3b8;
            --prev-month-color: #475569;
            --warning-color: #fbbf24;
            --info-color: #22d3ee;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            min-height: 100vh;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
        }
        
        .toast {
            background: var(--card-bg);
            border-left: 4px solid var(--primary-color);
            padding: 16px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 400px;
        }
        
        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .toast.success {
            border-left-color: var(--profit-color);
        }
        
        .toast.error {
            border-left-color: var(--loss-color);
        }
        
        .toast.warning {
            border-left-color: var(--warning-color);
        }
        
        .toast.info {
            border-left-color: var(--info-color);
        }
        
        .toast-icon {
            font-size: 20px;
        }
        
        .toast-message {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .toast-close {
            background: none;
            border: none;
            color: var(--neutral-color);
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .toast-close:hover {
            background-color: var(--border-color);
        }
        
        /* Enhanced Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 15px;
            overflow-y: auto;
        }
        
        .modal-loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            z-index: 10;
        }
        
        .dark-mode .modal-loading {
            background: rgba(0,0,0,0.8);
        }
        
        .modal-loading.show {
            display: flex;
        }
        
        .modal-content {
            background-color: var(--card-bg);
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .modal-header h2 {
            font-size: 20px;
            color: var(--text-color);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--neutral-color);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: background-color 0.2s;
        }
        
        .close-modal:hover {
            background-color: var(--border-color);
        }
        
        /* Enhanced Form Styles */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--neutral-color);
            font-size: 14px;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background-color: var(--card-bg);
            color: var(--text-color);
            transition: border-color 0.2s;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .form-group input.error, .form-group select.error, .form-group textarea.error {
            border-color: var(--loss-color);
        }
        
        .error-message {
            color: var(--loss-color);
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }
        
        .error-message.show {
            display: block;
        }
        
        /* Risk Metrics Section */
        .risk-metrics {
            background: var(--bg-color);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid var(--border-color);
        }
        
        .risk-metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .risk-metric:last-child {
            margin-bottom: 0;
        }
        
        .risk-label {
            color: var(--neutral-color);
            flex: 1;
        }
        
        .risk-value {
            font-weight: 600;
        }
        
        /* Trade Categories */
        .category-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 6px;
            margin-bottom: 4px;
        }
        
        .category-scalping { background: #dbeafe; color: #1e40af; }
        .category-day { background: #dcfce7; color: #166534; }
        .category-swing { background: #fef3c7; color: #92400e; }
        .category-position { background: #fce7f3; color: #9d174d; }
        
        .dark-mode .category-scalping { background: #1e3a8a; color: #dbeafe; }
        .dark-mode .category-day { background: #14532d; color: #dcfce7; }
        .dark-mode .category-swing { background: #713f12; color: #fef3c7; }
        .dark-mode .category-position { background: #831843; color: #fce7f3; }
        
        /* Confluence Styles */
        .confluence-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 8px;
            background: var(--bg-color);
        }
        
        .confluence-item:last-child {
            margin-bottom: 0;
        }
        
        .confluence-checkbox {
            width: 18px;
            height: 18px;
        }
        
        .confluence-label {
            flex: 1;
            font-size: 14px;
        }
        
        .confluence-score {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            background: var(--primary-color);
            color: white;
        }
        
        .confluence-score.high {
            background: var(--profit-color);
        }
        
        .confluence-score.medium {
            background: var(--warning-color);
        }
        
        .confluence-score.low {
            background: var(--loss-color);
        }
        
        .confluence-management {
            margin-top: 15px;
        }
        
        .confluence-management-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .confluence-management-item:last-child {
            border-bottom: none;
        }
        
        .confluence-actions {
            display: flex;
            gap: 8px;
        }
        
        /* Trade Details Modal */
        .trade-details {
            padding: 15px 0;
        }
        
        .trade-detail-item {
            display: flex;
            margin-bottom: 12px;
        }
        
        .trade-detail-label {
            font-weight: 600;
            min-width: 120px;
            color: var(--neutral-color);
        }
        
        .trade-detail-value {
            flex: 1;
        }
        
        .trade-confluences {
            margin-top: 15px;
        }
        
        .trade-confluence-score {
            font-size: 18px;
            font-weight: 700;
            text-align: center;
            margin: 15px 0;
            padding: 10px;
            border-radius: 8px;
            background: var(--bg-color);
        }
        
        /* Keyboard Shortcuts Help */
        .keyboard-shortcuts {
            background: var(--bg-color);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid var(--border-color);
        }
        
        .shortcut-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .shortcut-keys {
            background: var(--card-bg);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            font-family: monospace;
            font-size: 12px;
        }
        
        /* Existing styles with optimizations */
        .main-content {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-section i {
            font-size: 28px;
            color: var(--primary-color);
        }
        
        .logo-section h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .welcome-section h2 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .welcome-section p {
            color: var(--neutral-color);
            font-size: 14px;
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: var(--neutral-color);
            font-size: 14px;
            font-weight: 500;
        }
        
        .positive-stat {
            color: var(--profit-color);
        }
        
        .negative-stat {
            color: var(--loss-color);
        }
        
        .neutral-stat {
            color: var(--primary-color);
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .calendar-section {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-header h2 {
            font-size: 18px;
            font-weight: 600;
        }
        
        .month-nav {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .month-nav button {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: var(--neutral-color);
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .month-nav button:hover {
            background-color: var(--border-color);
        }
        
        .month-year {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
            min-width: 140px;
            text-align: center;
        }
        
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        
        .day-header {
            text-align: center;
            padding: 10px 5px;
            font-weight: 600;
            color: var(--neutral-color);
            font-size: 12px;
            text-transform: uppercase;
        }
        
        .day {
            background-color: var(--bg-color);
            border-radius: 8px;
            padding: 10px 8px;
            min-height: 80px;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .day:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }
        
        .day-number {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-color);
            font-size: 14px;
            line-height: 1.2;
        }
        
        .prev-month-day {
            color: var(--prev-month-color);
            opacity: 0.5;
        }
        
        .today {
            border: 2px solid var(--primary-color);
            background-color: var(--bg-color);
        }
        
        .today .day-number {
            color: var(--text-color);
        }
        
        .profit {
            color: var(--profit-color);
            font-weight: 600;
            font-size: 12px;
            line-height: 1.2;
        }
        
        .loss {
            color: var(--loss-color);
            font-weight: 600;
            font-size: 12px;
            line-height: 1.2;
        }
        
        .trade-count {
            font-size: 10px;
            color: var(--neutral-color);
            margin-top: 3px;
            line-height: 1.2;
        }
        
        .recent-trades {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            height: fit-content;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .section-header h2 {
            font-size: 18px;
            font-weight: 600;
        }
        
        .view-all {
            color: var(--primary-color);
            font-size: 14px;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }
        
        .trade-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .trade-item:hover {
            background-color: var(--bg-color);
            border-radius: 6px;
            padding-left: 10px;
            padding-right: 10px;
        }
        
        .trade-item:last-child {
            border-bottom: none;
        }
        
        .trade-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .trade-pair {
            font-weight: 600;
            color: var(--text-color);
            font-size: 14px;
        }
        
        .trade-date {
            color: var(--neutral-color);
            font-size: 12px;
        }
        
        .trade-profit {
            font-weight: 600;
            font-size: 14px;
        }
        
        .trade-profit.positive {
            color: var(--profit-color);
        }
        
        .trade-profit.negative {
            color: var(--loss-color);
        }
        
        .monthly-summary {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            margin-bottom: 25px;
        }
        
        .monthly-summary h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        
        .summary-stat {
            text-align: center;
            padding: 15px;
            background-color: var(--bg-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .summary-value {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .summary-label {
            color: var(--neutral-color);
            font-size: 12px;
            font-weight: 500;
        }
        
        .chart-container {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            margin-bottom: 25px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .chart-title {
            color: var(--text-color);
            font-size: 18px;
            font-weight: 600;
        }
        
        .current-balance {
            font-size: 24px;
            font-weight: 700;
            color: var(--profit-color);
        }
        
        .chart-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2563eb;
        }
        
        .btn-secondary {
            background-color: var(--border-color);
            color: var(--text-color);
        }
        
        .btn-danger {
            background-color: var(--loss-color);
            color: white;
        }
        
        .btn-success {
            background-color: var(--profit-color);
            color: white;
        }
        
        .icon-btn {
            background: none;
            border: none;
            color: var(--neutral-color);
            cursor: pointer;
            font-size: 18px;
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .icon-btn:hover {
            background-color: var(--border-color);
        }
        
        /* Win/Loss Toggle Styles */
        .toggle-group {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .toggle-option {
            flex: 1;
            text-align: center;
            padding: 12px 8px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            font-size: 14px;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        
        .toggle-option:hover {
            border-color: var(--primary-color);
        }
        
        .toggle-option.selected {
            border-color: var(--primary-color);
            background-color: var(--primary-color);
            color: white;
        }
        
        .toggle-option.win.selected {
            border-color: var(--profit-color);
            background-color: var(--profit-color);
        }
        
        .toggle-option.loss.selected {
            border-color: var(--loss-color);
            background-color: var(--loss-color);
        }
        
        .toggle-option.open.selected {
            border-color: var(--neutral-color);
            background-color: var(--neutral-color);
        }
        
        .form-row {
            display: flex;
            gap: 12px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Settings Styles */
        .settings-section {
            margin-bottom: 25px;
        }
        
        .settings-section h3 {
            margin-bottom: 15px;
            font-size: 16px;
            color: var(--text-color);
        }
        
        .theme-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background-color: var(--bg-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .theme-toggle label {
            font-weight: 500;
            color: var(--text-color);
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .file-input {
            display: none;
        }
        
        .file-input-label {
            display: block;
            padding: 12px 16px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.2s;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .file-input-label:hover {
            background-color: #2563eb;
        }
        
        .export-btn {
            background-color: var(--profit-color);
            color: white;
            margin-top: 10px;
            width: 100%;
        }
        
        .export-btn:hover {
            background-color: #0da271;
        }
        
        /* All Trades Modal */
        .all-trades-modal .modal-content {
            max-width: 800px;
        }
        
        .trades-list {
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .trade-management-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .trade-management-item:last-child {
            border-bottom: none;
        }
        
        .trade-management-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        
        .trade-management-pair {
            font-weight: 600;
            color: var(--text-color);
            min-width: 100px;
        }
        
        .trade-management-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .trade-management-type.buy {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .trade-management-type.sell {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .trade-management-date {
            color: var(--neutral-color);
            font-size: 12px;
            min-width: 120px;
        }
        
        .trade-management-amount {
            color: var(--neutral-color);
            font-size: 14px;
        }
        
        .trade-management-actions {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            padding: 6px 10px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .edit-btn {
            color: var(--primary-color);
            background-color: var(--border-color);
        }
        
        .delete-btn {
            color: var(--loss-color);
            background-color: var(--border-color);
        }
        
        /* Day Summary Styles */
        .day-summary {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }
        
        .day-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .day-summary-header h2 {
            font-size: 18px;
            font-weight: 600;
        }
        
        .day-summary-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .day-summary-stat {
            text-align: center;
            padding: 15px;
            background-color: var(--bg-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .day-summary-value {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .day-summary-label {
            color: var(--neutral-color);
            font-size: 12px;
            font-weight: 500;
        }
        
        /* Bulk Selection Styles */
        .bulk-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .bulk-actions .btn {
            flex: 1;
            min-width: 120px;
        }
        
        .select-all-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: var(--bg-color);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
        }
        
        .select-all-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .selected-count {
            font-size: 14px;
            color: var(--neutral-color);
        }
        
        .trade-management-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        /* Focus styles for accessibility */
        button:focus-visible, 
        input:focus-visible, 
        select:focus-visible,
        textarea:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
        
        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-cards {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .main-content {
                padding: 15px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .header-actions {
                align-self: flex-end;
            }
            
            .stats-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .trade-management-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .trade-management-actions {
                align-self: flex-end;
            }
            
            .bulk-actions {
                flex-direction: column;
            }
            
            .bulk-actions .btn {
                width: 100%;
            }
            
            /* Remove calendar label on mobile */
            .calendar-header h2 {
                display: none;
            }
            
            .calendar-header {
                justify-content: center;
            }
            
            .chart-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            /* Fix toggle buttons on mobile */
            .toggle-group {
                flex-direction: column;
            }
            
            .toggle-option {
                padding: 14px 12px;
                font-size: 16px;
            }
        }
        
        @media (max-width: 480px) {
            .stats-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .calendar {
                gap: 4px;
            }
            
            .day {
                min-height: 70px;
                padding: 8px 6px;
            }
            
            .day-header {
                padding: 8px 4px;
                font-size: 11px;
            }
            
            .day-number {
                font-size: 12px;
            }
            
            .profit, .loss {
                font-size: 10px;
            }
            
            .month-nav {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .today-btn {
                margin-top: 10px;
                width: 100%;
            }
            
            /* Further improve toggle buttons on very small screens */
            .toggle-option {
                padding: 16px 12px;
                font-size: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Toast Notifications Container -->
    <div class="toast-container" id="toast-container"></div>
    
    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <div class="logo-section">
                <i class="fas fa-chart-line"></i>
                <h1>TradeTracker Pro</h1>
            </div>
            <div class="welcome-section">
                <h2>Welcome, Trader</h2>
                <p>Here's your trading overview for today</p>
            </div>
            <div class="header-actions">
                <button class="icon-btn" id="settings-btn" title="Settings">
                    <i class="fas fa-cog"></i>
                </button>
                <button class="icon-btn" id="help-btn" title="Keyboard Shortcuts">
                    <i class="fas fa-keyboard"></i>
                </button>
                <button class="btn btn-primary" id="add-trade-btn">
                    <i class="fas fa-plus"></i> Add Trade
                </button>
            </div>
        </div>
        
        <!-- Stats Cards -->
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-value positive-stat" id="total-profit">+$0.00</div>
                <div class="stat-label">P&L</div>
            </div>
            <div class="stat-card">
                <div class="stat-value neutral-stat" id="total-trades">0</div>
                <div class="stat-label">Total Trades</div>
            </div>
            <div class="stat-card">
                <div class="stat-value neutral-stat" id="win-rate">0%</div>
                <div class="stat-label">Win Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-value neutral-stat" id="profit-factor">0.00</div>
                <div class="stat-label">Profit Factor</div>
            </div>
            <div class="stat-card">
                <div class="stat-value neutral-stat" id="risk-reward">0.00</div>
                <div class="stat-label">Avg R:R</div>
            </div>
        </div>
        
        <!-- Account Balance Chart -->
        <div class="chart-container">
            <div class="chart-header">
                <h2 class="chart-title">Account Balance</h2>
                <div class="current-balance" id="current-balance">$5,000.00</div>
            </div>
            <div class="chart-wrapper">
                <canvas id="balance-chart"></canvas>
            </div>
        </div>
        
        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Calendar Section -->
            <div class="calendar-section">
                <div class="calendar-header">
                    <h2>Calendar</h2>
                    <div class="month-nav">
                        <button id="prev-month"><i class="fas fa-chevron-left"></i></button>
                        <div class="month-year" id="current-month">June 2025</div>
                        <button id="next-month"><i class="fas fa-chevron-right"></i></button>
                        <button class="btn btn-secondary today-btn" id="today-btn">Today</button>
                    </div>
                </div>
                <div class="calendar" id="calendar">
                    <!-- Calendar will be generated by JavaScript -->
                </div>
            </div>
            
            <!-- Recent Trades / Day Summary Section -->
            <div class="recent-trades" id="right-panel">
                <div class="section-header">
                    <h2 id="right-panel-title">Recent Trades</h2>
                    <a class="view-all" id="view-all-trades">View All</a>
                </div>
                <div id="right-panel-content">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Monthly Summary -->
        <div class="monthly-summary">
            <h2>Summary: <span id="summary-month">June 2025</span></h2>
            <div class="summary-stats">
                <div class="summary-stat">
                    <div class="summary-value" id="monthly-trades">0</div>
                    <div class="summary-label">Total Trades</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-value positive-stat" id="monthly-profit">+$0.00</div>
                    <div class="summary-label">Total P&L</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-value" id="monthly-win-rate">0%</div>
                    <div class="summary-label">Win Rate</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-value" id="monthly-profit-factor">0.00</div>
                    <div class="summary-label">Profit Factor</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Trade Modal -->
    <div class="modal" id="trade-modal">
        <div class="modal-content">
            <div class="modal-loading" id="trade-modal-loading">
                <div class="loading-spinner"></div>
            </div>
            <div class="modal-header">
                <h2 id="trade-modal-title">Add New Trade</h2>
                <button class="close-modal" id="close-modal">&times;</button>
            </div>
            <form id="trade-form">
                <div class="form-group">
                    <label for="pair">Trading Pair</label>
                    <input type="text" id="pair" placeholder="e.g., EUR/USD, BTC/USD" required>
                    <div class="error-message" id="pair-error">Please enter a valid trading pair</div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="type">Type</label>
                        <select id="type" required>
                            <option value="BUY">BUY</option>
                            <option value="SELL">SELL</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="amount">Amount Risked ($)</label>
                        <input type="number" id="amount" placeholder="e.g., 100" min="0" step="0.01" required>
                        <div class="error-message" id="amount-error">Please enter a valid amount</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="entry-time">Entry Time</label>
                        <input type="datetime-local" id="entry-time" required>
                        <div class="error-message" id="entry-time-error">Please enter a valid entry time</div>
                    </div>
                    <div class="form-group">
                        <label for="close-time">Close Time</label>
                        <input type="datetime-local" id="close-time">
                        <div class="error-message" id="close-time-error">Close time must be after entry time</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="category">Trade Category</label>
                    <select id="category">
                        <option value="scalping">Scalping</option>
                        <option value="day">Day Trading</option>
                        <option value="swing">Swing Trading</option>
                        <option value="position">Position Trading</option>
                    </select>
                </div>
                
                <!-- Confluences Section -->
                <div class="form-group">
                    <label>Confluences Met</label>
                    <div id="confluence-checkboxes">
                        <!-- Confluence checkboxes will be populated here -->
                    </div>
                    <div id="confluence-score-preview" style="margin-top: 10px; display: none;">
                        <div class="confluence-score" id="confluence-score-value">0%</div>
                        <small style="color: var(--neutral-color);">Confluence Score</small>
                    </div>
                </div>
                
                <!-- Win/Loss Toggle -->
                <div class="form-group">
                    <label>Trade Result</label>
                    <div class="toggle-group">
                        <div class="toggle-option win" data-value="win">Win</div>
                        <div class="toggle-option loss" data-value="loss">Loss</div>
                        <div class="toggle-option open selected" data-value="open">Open</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="profit-loss">Profit/Loss Amount ($)</label>
                    <input type="number" id="profit-loss" placeholder="e.g., 50" min="0" step="0.01">
                    <div class="error-message" id="profit-loss-error">Please enter a valid amount</div>
                    <small style="color: var(--neutral-color);">Amount will be positive for wins and negative for losses</small>
                </div>
                
                <div class="form-group">
                    <label for="notes">Trade Notes</label>
                    <textarea id="notes" placeholder="Add any notes about this trade..." rows="3"></textarea>
                </div>
                
                <!-- Risk Metrics Preview -->
                <div class="risk-metrics" id="risk-metrics-preview" style="display: none;">
                    <h4 style="margin-bottom: 10px;">Risk Metrics</h4>
                    <div class="risk-metric">
                        <span class="risk-label">Risk/Reward Ratio:</span>
                        <span class="risk-value" id="risk-reward-preview">-</span>
                    </div>
                    <div class="risk-metric">
                        <span class="risk-label">Risk %:</span>
                        <span class="risk-value" id="risk-percent-preview">-</span>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancel-trade">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="save-trade-btn">
                        <span id="save-trade-text">Save Trade</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="close-modal" id="close-settings">&times;</button>
            </div>
            
            <div class="settings-section">
                <h3>Appearance</h3>
                <div class="theme-toggle">
                    <label for="dark-mode-toggle">Dark Mode</label>
                    <label class="switch">
                        <input type="checkbox" id="dark-mode-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="settings-section">
                <h3>Account Balance</h3>
                <div class="form-group">
                    <label for="initial-balance">Initial Account Balance ($)</label>
                    <input type="number" id="initial-balance" placeholder="e.g., 5000" min="0" step="0.01">
                    <div class="error-message" id="balance-error">Please enter a valid balance</div>
                </div>
                <button type="button" class="btn btn-primary" id="save-balance">Save Balance</button>
            </div>
            
            <!-- Confluence Management Section -->
            <div class="settings-section">
                <h3>Trade Confluences</h3>
                <div class="form-group">
                    <label for="new-confluence">Add New Confluence</label>
                    <input type="text" id="new-confluence" placeholder="e.g., EMA Cross, RSI Oversold">
                    <button type="button" class="btn btn-primary" id="add-confluence" style="margin-top: 10px;">Add Confluence</button>
                </div>
                <div class="confluence-management" id="confluence-list">
                    <!-- Confluences will be populated here -->
                </div>
            </div>
            
            <div class="settings-section">
                <h3>Data Management</h3>
                <button type="button" class="btn export-btn" id="export-excel">
                    <i class="fas fa-file-export"></i> Export to Excel
                </button>
                <label for="import-excel" class="file-input-label">
                    <i class="fas fa-file-import"></i> Import from Excel
                </label>
                <input type="file" id="import-excel" class="file-input" accept=".xlsx, .xls">
                <div class="form-group">
                    <label for="backup-file">Backup File Password (Optional)</label>
                    <input type="password" id="backup-password" placeholder="Enter password for encryption">
                </div>
                <button type="button" class="btn btn-secondary" id="create-backup">
                    <i class="fas fa-download"></i> Create Encrypted Backup
                </button>
                <div id="import-status" style="margin-top: 10px; font-size: 14px; color: var(--neutral-color);"></div>
            </div>
            
            <div class="keyboard-shortcuts">
                <h3>Keyboard Shortcuts</h3>
                <div class="shortcut-item">
                    <span>Add New Trade</span>
                    <span class="shortcut-keys">N</span>
                </div>
                <div class="shortcut-item">
                    <span>Open Settings</span>
                    <span class="shortcut-keys">S</span>
                </div>
                <div class="shortcut-item">
                    <span>View All Trades</span>
                    <span class="shortcut-keys">A</span>
                </div>
                <div class="shortcut-item">
                    <span>Toggle Dark Mode</span>
                    <span class="shortcut-keys">D</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- All Trades Modal -->
    <div class="modal all-trades-modal" id="all-trades-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>All Trades</h2>
                <button class="close-modal" id="close-all-trades">&times;</button>
            </div>
            
            <!-- Search and Filter -->
            <div class="form-row" style="margin-bottom: 15px;">
                <div class="form-group">
                    <input type="text" id="trade-search" placeholder="Search trades...">
                </div>
                <div class="form-group">
                    <select id="trade-filter">
                        <option value="all">All Trades</option>
                        <option value="win">Winning Trades</option>
                        <option value="loss">Losing Trades</option>
                        <option value="open">Open Trades</option>
                        <option value="scalping">Scalping</option>
                        <option value="day">Day Trading</option>
                        <option value="swing">Swing Trading</option>
                        <option value="position">Position Trading</option>
                    </select>
                </div>
            </div>
            
            <!-- Bulk Actions -->
            <div class="bulk-actions">
                <button type="button" class="btn btn-secondary" id="select-all-trades">
                    <i class="fas fa-check-square"></i> Select All
                </button>
                <button type="button" class="btn btn-secondary" id="deselect-all-trades">
                    <i class="fas fa-square"></i> Deselect All
                </button>
                <button type="button" class="btn btn-danger" id="delete-selected-trades">
                    <i class="fas fa-trash"></i> Delete Selected
                </button>
                <button type="button" class="btn btn-danger" id="delete-all-trades">
                    <i class="fas fa-trash-alt"></i> Delete All
                </button>
            </div>
            
            <div class="select-all-row">
                <div class="select-all-checkbox">
                    <input type="checkbox" id="select-all-checkbox">
                    <label for="select-all-checkbox">Select All</label>
                </div>
                <div class="selected-count" id="selected-count">0 selected</div>
                <div class="trade-count" id="filtered-trade-count">Showing 0 of 0 trades</div>
            </div>
            
            <div class="trades-list" id="all-trades-list">
                <!-- All trades will be populated by JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Trade Details Modal -->
    <div class="modal" id="trade-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="trade-details-title">Trade Details</h2>
                <button class="close-modal" id="close-trade-details">&times;</button>
            </div>
            <div class="trade-details" id="trade-details-content">
                <!-- Trade details will be populated here -->
            </div>
        </div>
    </div>
    
    <!-- Help Modal -->
    <div class="modal" id="help-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Keyboard Shortcuts</h2>
                <button class="close-modal" id="close-help">&times;</button>
            </div>
            <div class="keyboard-shortcuts">
                <div class="shortcut-item">
                    <span>Add New Trade</span>
                    <span class="shortcut-keys">N</span>
                </div>
                <div class="shortcut-item">
                    <span>Open Settings</span>
                    <span class="shortcut-keys">S</span>
                </div>
                <div class="shortcut-item">
                    <span>View All Trades</span>
                    <span class="shortcut-keys">A</span>
                </div>
                <div class="shortcut-item">
                    <span>Toggle Dark Mode</span>
                    <span class="shortcut-keys">D</span>
                </div>
                <div class="shortcut-item">
                    <span>Go to Today</span>
                    <span class="shortcut-keys">T</span>
                </div>
                <div class="shortcut-item">
                    <span>Close Modal</span>
                    <span class="shortcut-keys">ESC</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Toast Notification System
        const ToastManager = {
            container: null,
            
            init() {
                this.container = document.getElementById('toast-container');
            },
            
            show(message, type = 'info', duration = 5000) {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                const icons = {
                    success: 'fa-check-circle',
                    error: 'fa-exclamation-circle',
                    warning: 'fa-exclamation-triangle',
                    info: 'fa-info-circle'
                };
                
                toast.innerHTML = `
                    <i class="fas ${icons[type]} toast-icon"></i>
                    <div class="toast-message">${this.escapeHtml(message)}</div>
                    <button class="toast-close">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                const closeBtn = toast.querySelector('.toast-close');
                closeBtn.addEventListener('click', () => this.hide(toast));
                
                this.container.appendChild(toast);
                
                setTimeout(() => toast.classList.add('show'), 10);
                
                if (duration > 0) {
                    setTimeout(() => this.hide(toast), duration);
                }
                
                return toast;
            },
            
            hide(toast) {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            },
            
            escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
        };

        // Validation System
        const Validation = {
            errors: {},
            
            validateTradeForm(formData) {
                this.errors = {};
                
                if (!formData.pair || formData.pair.trim().length < 2) {
                    this.errors.pair = 'Please enter a valid trading pair';
                }
                
                if (!formData.amount || formData.amount <= 0) {
                    this.errors.amount = 'Please enter a valid amount greater than 0';
                }
                
                if (!formData.entryTime) {
                    this.errors.entryTime = 'Please enter a valid entry time';
                } else if (new Date(formData.entryTime) > new Date()) {
                    this.errors.entryTime = 'Entry time cannot be in the future';
                }
                
                if (formData.closeTime && formData.entryTime) {
                    if (new Date(formData.closeTime) <= new Date(formData.entryTime)) {
                        this.errors.closeTime = 'Close time must be after entry time';
                    }
                }
                
                if (formData.status !== 'open') {
                    if (!formData.profitLoss && formData.profitLoss !== 0) {
                        this.errors.profitLoss = 'Please enter profit/loss amount for closed trades';
                    }
                }
                
                return Object.keys(this.errors).length === 0;
            },
            
            showErrors() {
                document.querySelectorAll('.error-message').forEach(el => {
                    el.classList.remove('show');
                });
                
                document.querySelectorAll('.form-group input, .form-group select').forEach(el => {
                    el.classList.remove('error');
                });
                
                Object.keys(this.errors).forEach(field => {
                    const errorEl = document.getElementById(`${field}-error`);
                    const inputEl = document.getElementById(field);
                    
                    if (errorEl && inputEl) {
                        errorEl.textContent = this.errors[field];
                        errorEl.classList.add('show');
                        inputEl.classList.add('error');
                    }
                });
            }
        };

        // Confluence Management
        const ConfluenceManager = {
            confluences: [],
            
            init() {
                this.loadConfluences();
            },
            
            loadConfluences() {
                const savedConfluences = localStorage.getItem('tradeTrackerConfluences');
                if (savedConfluences) {
                    try {
                        this.confluences = JSON.parse(savedConfluences);
                    } catch (error) {
                        ToastManager.show('Error loading confluences', 'error');
                    }
                }
            },
            
            saveConfluences() {
                try {
                    localStorage.setItem('tradeTrackerConfluences', JSON.stringify(this.confluences));
                } catch (error) {
                    ToastManager.show('Error saving confluences', 'error');
                }
            },
            
            addConfluence(name) {
                const newConfluence = {
                    id: this.confluences.length > 0 ? Math.max(...this.confluences.map(c => c.id)) + 1 : 1,
                    name: name,
                    createdAt: new Date().toISOString()
                };
                
                this.confluences.push(newConfluence);
                this.saveConfluences();
                return newConfluence;
            },
            
            deleteConfluence(confluenceId) {
                this.confluences = this.confluences.filter(c => c.id !== confluenceId);
                this.saveConfluences();
            },
            
            renderConfluenceList() {
                const confluenceList = document.getElementById('confluence-list');
                confluenceList.innerHTML = '';
                
                if (this.confluences.length === 0) {
                    confluenceList.innerHTML = '<p style="text-align: center; color: var(--neutral-color); padding: 10px;">No confluences added yet.</p>';
                    return;
                }
                
                this.confluences.forEach(confluence => {
                    const confluenceItem = document.createElement('div');
                    confluenceItem.className = 'confluence-management-item';
                    confluenceItem.innerHTML = `
                        <div class="confluence-label">${confluence.name}</div>
                        <div class="confluence-actions">
                            <button class="action-btn delete-btn" data-id="${confluence.id}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    `;
                    confluenceList.appendChild(confluenceItem);
                });
                
                // Add event listeners to delete buttons
                confluenceList.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const confluenceId = parseInt(btn.getAttribute('data-id'));
                        this.deleteConfluence(confluenceId);
                        this.renderConfluenceList();
                        ToastManager.show('Confluence deleted successfully', 'success');
                    });
                });
            },
            
            renderConfluenceCheckboxes(selectedConfluences = []) {
                const checkboxesContainer = document.getElementById('confluence-checkboxes');
                checkboxesContainer.innerHTML = '';
                
                if (this.confluences.length === 0) {
                    checkboxesContainer.innerHTML = '<p style="color: var(--neutral-color); text-align: center; padding: 10px;">No confluences defined. Add them in Settings.</p>';
                    return;
                }
                
                this.confluences.forEach(confluence => {
                    const isChecked = selectedConfluences.includes(confluence.id);
                    const confluenceItem = document.createElement('div');
                    confluenceItem.className = 'confluence-item';
                    confluenceItem.innerHTML = `
                        <input type="checkbox" class="confluence-checkbox" id="confluence-${confluence.id}" value="${confluence.id}" ${isChecked ? 'checked' : ''}>
                        <label class="confluence-label" for="confluence-${confluence.id}">${confluence.name}</label>
                    `;
                    checkboxesContainer.appendChild(confluenceItem);
                });
                
                // Add event listeners to update confluence score
                checkboxesContainer.querySelectorAll('.confluence-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        this.updateConfluenceScorePreview();
                    });
                });
                
                this.updateConfluenceScorePreview();
            },
            
            updateConfluenceScorePreview() {
                const checkboxes = document.querySelectorAll('.confluence-checkbox');
                const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
                const totalCount = checkboxes.length;
                
                const scorePreview = document.getElementById('confluence-score-preview');
                const scoreValue = document.getElementById('confluence-score-value');
                
                if (totalCount > 0) {
                    const score = Math.round((checkedCount / totalCount) * 100);
                    scoreValue.textContent = `${score}%`;
                    
                    // Set color based on score
                    if (score >= 80) {
                        scoreValue.className = 'confluence-score high';
                    } else if (score >= 50) {
                        scoreValue.className = 'confluence-score medium';
                    } else {
                        scoreValue.className = 'confluence-score low';
                    }
                    
                    scorePreview.style.display = 'block';
                } else {
                    scorePreview.style.display = 'none';
                }
            },
            
            getSelectedConfluences() {
                const checkboxes = document.querySelectorAll('.confluence-checkbox:checked');
                return Array.from(checkboxes).map(cb => parseInt(cb.value));
            },
            
            calculateConfluenceScore(selectedConfluences) {
                if (this.confluences.length === 0) return 0;
                return Math.round((selectedConfluences.length / this.confluences.length) * 100);
            },
            
            getConfluenceNames(confluenceIds) {
                return confluenceIds.map(id => {
                    const confluence = this.confluences.find(c => c.id === id);
                    return confluence ? confluence.name : 'Unknown';
                });
            }
        };

        // Security and Encryption
        const Security = {
            encrypt(data, password = '') {
                if (!password) return btoa(JSON.stringify(data));
                
                let encrypted = '';
                for (let i = 0; i < JSON.stringify(data).length; i++) {
                    encrypted += String.fromCharCode(
                        JSON.stringify(data).charCodeAt(i) ^ password.charCodeAt(i % password.length)
                    );
                }
                return btoa(encrypted);
            },
            
            decrypt(encryptedData, password = '') {
                try {
                    if (!password) {
                        return JSON.parse(atob(encryptedData));
                    }
                    
                    const decoded = atob(encryptedData);
                    let decrypted = '';
                    for (let i = 0; i < decoded.length; i++) {
                        decrypted += String.fromCharCode(
                            decoded.charCodeAt(i) ^ password.charCodeAt(i % password.length)
                        );
                    }
                    return JSON.parse(decrypted);
                } catch (error) {
                    throw new Error('Failed to decrypt data. Check your password.');
                }
            }
        };

        // Performance Optimizations
        const Performance = {
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        };

        // Trade Management
        const TradeManager = {
            trades: [],
            
            init() {
                this.loadTrades();
            },
            
            loadTrades() {
                const savedTrades = localStorage.getItem('tradeTrackerTrades');
                if (savedTrades) {
                    try {
                        this.trades = JSON.parse(savedTrades);
                    // Ensure all trades have confluences array
                        this.trades.forEach(trade => {
                        if (!trade.confluences) trade.confluences = [];
                        if (!trade.confluenceScore) trade.confluenceScore = 0;
                    });
                    } catch (error) {
                        ToastManager.show('Error loading trades data', 'error');
                    }
                }
            },
            
            saveTrades() {
                try {
                    localStorage.setItem('tradeTrackerTrades', JSON.stringify(this.trades));
                } catch (error) {
                    ToastManager.show('Error saving trades data', 'error');
                }
            },
            
            addTrade(tradeData) {
                const newTrade = {
                    id: this.trades.length > 0 ? Math.max(...this.trades.map(t => t.id)) + 1 : 1,
                    ...tradeData,
                    createdAt: new Date().toISOString()
                };
                
                this.trades.push(newTrade);
                this.saveTrades();
                return newTrade;
            },
            
            updateTrade(tradeId, tradeData) {
                const index = this.trades.findIndex(t => t.id === tradeId);
                if (index !== -1) {
                    this.trades[index] = {
                        ...this.trades[index],
                        ...tradeData,
                        updatedAt: new Date().toISOString()
                    };
                    this.saveTrades();
                    return this.trades[index];
                }
                return null;
            },
            
            deleteTrade(tradeId) {
                this.trades = this.trades.filter(t => t.id !== tradeId);
                this.saveTrades();
            },
            
            deleteMultipleTrades(tradeIds) {
                this.trades = this.trades.filter(t => !tradeIds.includes(t.id));
                this.saveTrades();
            },
            
            calculateRiskMetrics(trade, initialBalance) {
                if (trade.status === 'open' || !trade.profitLoss) return null;
                
                const riskPercent = (trade.amount / initialBalance * 100).toFixed(2);
                const riskReward = trade.profitLoss > 0 ? 
                    (trade.profitLoss / trade.amount).toFixed(2) : 
                    (Math.abs(trade.profitLoss) / trade.amount).toFixed(2);
                
                return {
                    riskPercent,
                    riskReward
                };
            },
            
            getTradeStats() {
                const closedTrades = this.trades.filter(t => t.status === 'closed');
                const totalProfit = closedTrades.reduce((sum, t) => sum + t.profitLoss, 0);
                const winningTrades = closedTrades.filter(t => t.profitLoss > 0);
                const winRate = closedTrades.length > 0 ? 
                    Math.round((winningTrades.length / closedTrades.length) * 100) : 0;
                
                const totalWins = winningTrades.reduce((sum, t) => sum + t.profitLoss, 0);
                const totalLosses = Math.abs(closedTrades
                    .filter(t => t.profitLoss < 0)
                    .reduce((sum, t) => sum + t.profitLoss, 0));
                const profitFactor = totalLosses > 0 ? 
                    (totalWins / totalLosses).toFixed(2) : 
                    totalWins > 0 ? '' : '0.00';
                
                const avgRiskReward = closedTrades.length > 0 ?
                    (closedTrades.reduce((sum, t) => {
                        const metrics = this.calculateRiskMetrics(t, settings.initialBalance);
                        return sum + (metrics ? parseFloat(metrics.riskReward) : 0);
                    }, 0) / closedTrades.length).toFixed(2) : '0.00';
                
                return {
                    totalProfit,
                    totalTrades: this.trades.length,
                    winRate,
                    profitFactor,
                    avgRiskReward,
                    closedTrades: closedTrades.length,
                    winningTrades: winningTrades.length
                };
            }
        };

        // Settings Management
        const SettingsManager = {
            settings: {
                initialBalance: 5000,
                darkMode: false
            },
            
            init() {
                this.loadSettings();
            },
            
            loadSettings() {
                const savedSettings = localStorage.getItem('tradeTrackerSettings');
                if (savedSettings) {
                    try {
                        this.settings = { ...this.settings, ...JSON.parse(savedSettings) };
                    } catch (error) {
                        ToastManager.show('Error loading settings', 'error');
                    }
                }
            },
            
            saveSettings() {
                try {
                    localStorage.setItem('tradeTrackerSettings', JSON.stringify(this.settings));
                    return true;
                } catch (error) {
                    ToastManager.show('Error saving settings', 'error');
                    return false;
                }
            },
            
            updateSetting(key, value) {
                this.settings[key] = value;
                return this.saveSettings();
            }
        };

        // Chart Management
        const ChartManager = {
            chart: null,
            
            init() {
                this.renderChart([], []);
            },
            
            renderChart(labels, data) {
                const ctx = document.getElementById('balance-chart').getContext('2d');
                const textColor = getComputedStyle(document.body).getPropertyValue('--text-color');
                const gridColor = getComputedStyle(document.body).getPropertyValue('--border-color');
                const primaryColor = getComputedStyle(document.body).getPropertyValue('--primary-color');
                
                if (this.chart) {
                    this.chart.destroy();
                }
                
                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Account Balance',
                            data: data,
                            borderColor: primaryColor,
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { 
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            },
                            y: {
                                ticks: { 
                                    color: textColor,
                                    callback: value => '$' + value.toLocaleString()
                                },
                                grid: { color: gridColor }
                            }
                        }
                    }
                });
            },
            
            updateChart() {
                const closedTrades = TradeManager.trades
                    .filter(t => t.status === 'closed')
                    .sort((a, b) => new Date(a.closeTime) - new Date(b.closeTime));
                
                let balanceData = [SettingsManager.settings.initialBalance];
                let labels = ['Initial'];
                let runningBalance = SettingsManager.settings.initialBalance;
                
                closedTrades.forEach(trade => {
                    runningBalance += trade.profitLoss;
                    balanceData.push(runningBalance);
                    const date = new Date(trade.closeTime);
                    labels.push(`${date.getMonth()+1}/${date.getDate()}`);
                });
                
                this.renderChart(labels, balanceData);
                
                const currentBalance = balanceData[balanceData.length - 1];
                document.getElementById('current-balance').textContent = 
                    `$${currentBalance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            }
        };

        // Keyboard Shortcuts
        const KeyboardManager = {
            init() {
                document.addEventListener('keydown', this.handleKeyPress.bind(this));
            },
            
            handleKeyPress(event) {
                if (event.target.tagName === 'INPUT' || 
                    event.target.tagName === 'TEXTAREA' || 
                    event.target.isContentEditable) {
                    return;
                }
                
                const hasModifier = event.ctrlKey || event.metaKey || event.altKey;
                
                switch (event.key.toLowerCase()) {
                    case 'n':
                        if (!hasModifier) {
                            event.preventDefault();
                            document.getElementById('add-trade-btn').click();
                        }
                        break;
                    case 's':
                        if (!hasModifier) {
                            event.preventDefault();
                            document.getElementById('settings-btn').click();
                        }
                        break;
                    case 'a':
                        if (!hasModifier) {
                            event.preventDefault();
                            document.getElementById('view-all-trades').click();
                        }
                        break;
                    case 'd':
                        if (!hasModifier) {
                            event.preventDefault();
                            document.getElementById('dark-mode-toggle').click();
                        }
                        break;
                    case 't':
                        if (!hasModifier) {
                            event.preventDefault();
                            document.getElementById('today-btn').click();
                        }
                        break;
                    case 'escape':
                        this.closeActiveModal();
                        break;
                    case '?':
                        event.preventDefault();
                        document.getElementById('help-btn').click();
                        break;
                }
            },
            
            closeActiveModal() {
                const modals = document.querySelectorAll('.modal');
                for (let modal of modals) {
                    if (modal.style.display === 'flex') {
                        modal.style.display = 'none';
                        document.body.style.overflow = 'auto';
                        break;
                    }
                }
            }
        };

        // Global variables
        let currentDate = new Date();
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();
        let editingTradeId = null;
        let selectedDay = null;
        let selectedTradeIds = new Set();
        let tradeResult = 'open';
        let settings = SettingsManager.settings;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize all managers
            ToastManager.init();
            TradeManager.init();
            SettingsManager.init();
            ConfluenceManager.init();
            ChartManager.init();
            KeyboardManager.init();
            
            // Set up UI
            renderCalendar();
            updateStats();
            renderRecentTrades();
            ChartManager.updateChart();
            updateMonthlySummary();
            ConfluenceManager.renderConfluenceList();
            
            // Load settings
            const savedSettings = localStorage.getItem('tradeTrackerSettings');
            if (savedSettings) {
                settings = JSON.parse(savedSettings);
                document.getElementById('dark-mode-toggle').checked = settings.darkMode;
                document.getElementById('initial-balance').value = settings.initialBalance;
                if (settings.darkMode) {
                    document.body.classList.add('dark-mode');
                }
            }
            
            // Set up event listeners
            setupEventListeners();
            
            // Show welcome message
            setTimeout(() => {
                ToastManager.show('TradeTracker Pro loaded successfully! Press ? for keyboard shortcuts', 'info', 4000);
            }, 500);
        });

        // Event Listeners Setup
        function setupEventListeners() {
            // Modal controls
            document.getElementById('settings-btn').addEventListener('click', openSettingsModal);
            document.getElementById('add-trade-btn').addEventListener('click', openAddTradeModal);
            document.getElementById('help-btn').addEventListener('click', openHelpModal);
            document.getElementById('close-modal').addEventListener('click', closeModal);
            document.getElementById('cancel-trade').addEventListener('click', closeModal);
            document.getElementById('close-settings').addEventListener('click', closeSettingsModal);
            document.getElementById('close-all-trades').addEventListener('click', closeAllTradesModal);
            document.getElementById('close-help').addEventListener('click', closeHelpModal);
            document.getElementById('close-trade-details').addEventListener('click', closeTradeDetailsModal);
            
            // Calendar controls
            document.getElementById('prev-month').addEventListener('click', goToPreviousMonth);
            document.getElementById('next-month').addEventListener('click', goToNextMonth);
            document.getElementById('today-btn').addEventListener('click', goToToday);
            
            // Form submissions
            document.getElementById('trade-form').addEventListener('submit', handleTradeSubmit);
            document.getElementById('save-balance').addEventListener('click', handleSaveBalance);
            
            // Confluence management
            document.getElementById('add-confluence').addEventListener('click', handleAddConfluence);
            
            // Data management
            document.getElementById('export-excel').addEventListener('click', handleExportExcel);
            document.getElementById('import-excel').addEventListener('change', handleImportExcel);
            document.getElementById('create-backup').addEventListener('click', handleCreateBackup);
            document.getElementById('view-all-trades').addEventListener('click', openAllTradesModal);
            
            // Theme toggle
            document.getElementById('dark-mode-toggle').addEventListener('change', toggleDarkMode);
            
            // Trade result toggle
            initTradeResultToggle();
            
            // Real-time validation
            document.getElementById('amount').addEventListener('input', updateRiskMetrics);
            document.getElementById('profit-loss').addEventListener('input', updateRiskMetrics);
            
            // Bulk actions
            document.getElementById('select-all-trades').addEventListener('click', selectAllTrades);
            document.getElementById('deselect-all-trades').addEventListener('click', deselectAllTrades);
            document.getElementById('delete-selected-trades').addEventListener('click', deleteSelectedTrades);
            document.getElementById('delete-all-trades').addEventListener('click', deleteAllTrades);
            document.getElementById('select-all-checkbox').addEventListener('change', toggleSelectAll);
            
            // Search and filter with debouncing
            document.getElementById('trade-search').addEventListener('input', 
                Performance.debounce(handleTradeSearch, 300)
            );
            document.getElementById('trade-filter').addEventListener('change', 
                Performance.debounce(handleTradeFilter, 300)
            );
            
            // Close modals when clicking outside
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            });
        }

        // Initialize trade result toggle
        function initTradeResultToggle() {
            const toggleOptions = document.querySelectorAll('.toggle-option');
            toggleOptions.forEach(option => {
                option.addEventListener('click', function() {
                    toggleOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    tradeResult = this.getAttribute('data-value');
                    
                    const profitLossInput = document.getElementById('profit-loss');
                    if (tradeResult === 'open') {
                        profitLossInput.disabled = true;
                        profitLossInput.value = '';
                    } else {
                        profitLossInput.disabled = false;
                    }
                    
                    updateRiskMetrics();
                });
            });
        }

        // Update risk metrics in real-time
        function updateRiskMetrics() {
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const profitLoss = parseFloat(document.getElementById('profit-loss').value) || 0;
            const riskMetrics = document.getElementById('risk-metrics-preview');
            
            if (amount > 0 && tradeResult !== 'open') {
                const riskPercent = (amount / settings.initialBalance * 100).toFixed(2);
                const riskReward = (profitLoss / amount).toFixed(2);
                
                document.getElementById('risk-reward-preview').textContent = riskReward;
                document.getElementById('risk-percent-preview').textContent = riskPercent + '%';
                riskMetrics.style.display = 'block';
            } else {
                riskMetrics.style.display = 'none';
            }
        }

        // Confluence management
        function handleAddConfluence() {
            const confluenceInput = document.getElementById('new-confluence');
            const name = confluenceInput.value.trim();
            
            if (!name) {
                ToastManager.show('Please enter a confluence name', 'warning');
                return;
            }
            
            ConfluenceManager.addConfluence(name);
            ConfluenceManager.renderConfluenceList();
            confluenceInput.value = '';
            ToastManager.show('Confluence added successfully', 'success');
        }

        // Calendar functions
        function renderCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendarEl.innerHTML = '';
            
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header';
                dayHeader.textContent = day;
                calendarEl.appendChild(dayHeader);
            });
            
            const monthYear = `${getMonthName(currentMonth)} ${currentYear}`;
            document.getElementById('current-month').textContent = monthYear;
            document.getElementById('summary-month').textContent = monthYear;
            
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const prevMonthLastDay = new Date(currentYear, currentMonth, 0).getDate();
            
            for (let i = firstDay - 1; i >= 0; i--) {
                const dayEl = document.createElement('div');
                dayEl.className = 'day prev-month-day';
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = prevMonthLastDay - i;
                dayEl.appendChild(dayNumber);
                calendarEl.appendChild(dayEl);
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'day';
                
                const today = new Date();
                if (day === today.getDate() && 
                    currentMonth === today.getMonth() && 
                    currentYear === today.getFullYear()) {
                    dayEl.classList.add('today');
                }
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayEl.appendChild(dayNumber);
                
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dailyTrades = getTradesForDay(dateStr);
                const closedTrades = dailyTrades.filter(trade => trade.status === 'closed');
                const dailyProfitLoss = closedTrades.reduce((sum, trade) => sum + trade.profitLoss, 0);
                
                if (closedTrades.length > 0) {
                    const pnlEl = document.createElement('div');
                    pnlEl.className = dailyProfitLoss >= 0 ? 'profit' : 'loss';
                    pnlEl.textContent = dailyProfitLoss >= 0 ? `+$${dailyProfitLoss.toFixed(2)}` : `-$${Math.abs(dailyProfitLoss).toFixed(2)}`;
                    dayEl.appendChild(pnlEl);
                }
                
                if (dailyTrades.length > 0) {
                    const tradeCount = document.createElement('div');
                    tradeCount.className = 'trade-count';
                    tradeCount.textContent = `${dailyTrades.length} trade${dailyTrades.length > 1 ? 's' : ''}`;
                    dayEl.appendChild(tradeCount);
                }
                
                dayEl.addEventListener('click', function() {
                    showDaySummary(dateStr, day);
                });
                
                calendarEl.appendChild(dayEl);
            }
            
            const totalCells = 42;
            const cellsUsed = firstDay + daysInMonth;
            const nextMonthDays = totalCells - cellsUsed;
            
            for (let day = 1; day <= nextMonthDays; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'day prev-month-day';
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayEl.appendChild(dayNumber);
                calendarEl.appendChild(dayEl);
            }
        }

        function getTradesForDay(dateStr) {
            return TradeManager.trades.filter(trade => {
                if (trade.status === 'open') {
                    return trade.date === dateStr;
                } else {
                    const closeDate = trade.closeTime ? trade.closeTime.split('T')[0] : null;
                    return closeDate === dateStr;
                }
            });
        }

        function showDaySummary(dateStr, day) {
            selectedDay = dateStr;
            const dailyTrades = getTradesForDay(dateStr);
            const closedTrades = dailyTrades.filter(trade => trade.status === 'closed');
            const dailyProfitLoss = closedTrades.reduce((sum, trade) => sum + trade.profitLoss, 0);
            const winningTrades = closedTrades.filter(trade => trade.profitLoss > 0).length;
            const winRate = closedTrades.length > 0 ? Math.round((winningTrades / closedTrades.length) * 100) : 0;
            
            const dateObj = new Date(dateStr);
            const monthName = getMonthName(dateObj.getMonth());
            
            document.getElementById('right-panel-title').textContent = `Summary: ${monthName} ${day}`;
            document.getElementById('right-panel-content').innerHTML = `
                <div class="day-summary">
                    <div class="day-summary-stats">
                        <div class="day-summary-stat">
                            <div class="day-summary-value ${dailyProfitLoss >= 0 ? 'positive-stat' : 'negative-stat'}">
                                ${dailyProfitLoss >= 0 ? '+' : ''}$${dailyProfitLoss.toFixed(2)}
                            </div>
                            <div class="day-summary-label">Daily P&L</div>
                        </div>
                        <div class="day-summary-stat">
                            <div class="day-summary-value">${dailyTrades.length}</div>
                            <div class="day-summary-label">Total Trades</div>
                        </div>
                        <div class="day-summary-stat">
                            <div class="day-summary-value">${winRate}%</div>
                            <div class="day-summary-label">Win Rate</div>
                        </div>
                        <div class="day-summary-stat">
                            <div class="day-summary-value">${closedTrades.length}</div>
                            <div class="day-summary-label">Closed Trades</div>
                        </div>
                    </div>
                    <div class="day-trades-list">
                        ${dailyTrades.length > 0 ? 
                            dailyTrades.map(trade => {
                                const duration = calculateTradeDuration(trade.entryTime, trade.closeTime);
                                const categoryClass = trade.category ? `category-${trade.category}` : '';
                                const categoryName = trade.category ? trade.category.charAt(0).toUpperCase() + trade.category.slice(1) : '';
                                const confluenceScore = trade.confluenceScore || 0;
                                const scoreClass = confluenceScore >= 80 ? 'high' : confluenceScore >= 50 ? 'medium' : 'low';
                                
                                return `
                                <div class="trade-item" data-trade-id="${trade.id}">
                                    <div class="trade-info">
                                        <div class="trade-pair">${trade.pair} ${trade.category ? `<span class="category-badge ${categoryClass}">${categoryName}</span>` : ''}</div>
                                        <div class="trade-date">
                                            ${formatTime(trade.entryTime)} - ${trade.status === 'closed' ? formatTime(trade.closeTime) : 'Open'}
                                            <div style="font-size: 10px; color: var(--neutral-color); margin-top: 2px;">
                                                ${duration} <span class="confluence-score ${scoreClass}" style="margin-left: 5px;">${confluenceScore}%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="trade-profit ${trade.status === 'closed' ? (trade.profitLoss >= 0 ? 'positive' : 'negative') : ''}">
                                        ${trade.status === 'open' ? 'Open' : (trade.profitLoss >= 0 ? '+' : '') + '$' + trade.profitLoss.toFixed(2)}
                                    </div>
                                </div>
                                `;
                            }).join('') : 
                            '<p style="text-align: center; color: var(--neutral-color); padding: 20px;">No trades for this day</p>'
                        }
                    </div>
                </div>
            `;
            
            // Add click event listeners to trade items
            document.querySelectorAll('.trade-item[data-trade-id]').forEach(item => {
                item.addEventListener('click', function() {
                    const tradeId = parseInt(this.getAttribute('data-trade-id'));
                    showTradeDetails(tradeId);
                });
            });
        }

        function showTradeDetails(tradeId) {
            const trade = TradeManager.trades.find(t => t.id === tradeId);
            if (!trade) return;
            
            document.getElementById('trade-details-title').textContent = `Trade Details: ${trade.pair}`;
            
            const confluenceNames = ConfluenceManager.getConfluenceNames(trade.confluences || []);
            const confluenceScore = trade.confluenceScore || 0;
            const scoreClass = confluenceScore >= 80 ? 'high' : confluenceScore >= 50 ? 'medium' : 'low';
            
            document.getElementById('trade-details-content').innerHTML = `
                <div class="trade-detail-item">
                    <div class="trade-detail-label">Trading Pair:</div>
                    <div class="trade-detail-value">${trade.pair}</div>
                </div>
                <div class="trade-detail-item">
                    <div class="trade-detail-label">Type:</div>
                    <div class="trade-detail-value">${trade.type}</div>
                </div>
                <div class="trade-detail-item">
                    <div class="trade-detail-label">Amount Risked:</div>
                    <div class="trade-detail-value">$${trade.amount.toFixed(2)}</div>
                </div>
                <div class="trade-detail-item">
                    <div class="trade-detail-label">Entry Time:</div>
                    <div class="trade-detail-value">${formatDateTime(trade.entryTime)}</div>
                </div>
                ${trade.closeTime ? `
                <div class="trade-detail-item">
                    <div class="trade-detail-label">Close Time:</div>
                    <div class="trade-detail-value">${formatDateTime(trade.closeTime)}</div>
                </div>
                ` : ''}
                <div class="trade-detail-item">
                    <div class="trade-detail-label">Status:</div>
                    <div class="trade-detail-value">${trade.status}</div>
                </div>
                ${trade.profitLoss !== null ? `
                <div class="trade-detail-item">
                    <div class="trade-detail-label">Profit/Loss:</div>
                    <div class="trade-detail-value ${trade.profitLoss >= 0 ? 'positive-stat' : 'negative-stat'}">
                        ${trade.profitLoss >= 0 ? '+' : ''}$${trade.profitLoss.toFixed(2)}
                    </div>
                </div>
                ` : ''}
                ${trade.category ? `
                <div class="trade-detail-item">
                    <div class="trade-detail-label">Category:</div>
                    <div class="trade-detail-value">${trade.category.charAt(0).toUpperCase() + trade.category.slice(1)}</div>
                </div>
                ` : ''}
                <div class="trade-confluence-score ${scoreClass}">
                    Confluence Score: ${confluenceScore}%
                </div>
                ${confluenceNames.length > 0 ? `
                <div class="trade-confluences">
                    <h4 style="margin-bottom: 10px;">Confluences Met:</h4>
                    <ul style="padding-left: 20px;">
                        ${confluenceNames.map(name => `<li>${name}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
                ${trade.notes ? `
                <div class="trade-detail-item">
                    <div class="trade-detail-label">Notes:</div>
                    <div class="trade-detail-value">${trade.notes}</div>
                </div>
                ` : ''}
            `;
            
            document.getElementById('trade-details-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeTradeDetailsModal() {
            document.getElementById('trade-details-modal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function calculateTradeDuration(entryTime, closeTime) {
            if (!closeTime) return 'Open';
            
            const entry = new Date(entryTime);
            const close = new Date(closeTime);
            const durationMs = close - entry;
            
            const days = Math.floor(durationMs / (1000 * 60 * 60 * 24));
            const hours = Math.floor((durationMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
            
            if (days > 0) {
                return `${days}d ${hours}h`;
            } else if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else {
                return `${minutes}m`;
            }
        }

        function goToPreviousMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
            updateMonthlySummary();
            showRecentTrades();
        }

        function goToNextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
            updateMonthlySummary();
            showRecentTrades();
        }

        function goToToday() {
            const today = new Date();
            currentMonth = today.getMonth();
            currentYear = today.getFullYear();
            renderCalendar();
            updateMonthlySummary();
            showRecentTrades();
        }

        function getMonthName(monthIndex) {
            const months = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            return months[monthIndex];
        }

        // Modal functions
        function openAddTradeModal() {
            editingTradeId = null;
            document.getElementById('trade-modal-title').textContent = 'Add New Trade';
            document.getElementById('trade-form').reset();
            
            tradeResult = 'open';
            const toggleOptions = document.querySelectorAll('.toggle-option');
            toggleOptions.forEach(opt => opt.classList.remove('selected'));
            document.querySelector('.toggle-option.open').classList.add('selected');
            
            document.getElementById('profit-loss').disabled = true;
            document.getElementById('profit-loss').value = '';
            document.getElementById('risk-metrics-preview').style.display = 'none';
            
            const today = new Date();
            const formatForInput = (date) => {
                return date.toISOString().slice(0, 16);
            };
            
            document.getElementById('entry-time').value = formatForInput(today);
            
            // Render confluence checkboxes
            ConfluenceManager.renderConfluenceCheckboxes();
            
            document.getElementById('trade-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function openEditTradeModal(tradeId) {
            editingTradeId = tradeId;
            const trade = TradeManager.trades.find(t => t.id === tradeId);
            
            if (!trade) return;
            
            document.getElementById('trade-modal-title').textContent = 'Edit Trade';
            document.getElementById('trade-form').reset();
            
            document.getElementById('pair').value = trade.pair;
            document.getElementById('type').value = trade.type;
            document.getElementById('amount').value = trade.amount;
            document.getElementById('entry-time').value = trade.entryTime;
            document.getElementById('category').value = trade.category || 'day';
            document.getElementById('notes').value = trade.notes || '';
            
            if (trade.closeTime) {
                document.getElementById('close-time').value = trade.closeTime;
            }
            
            const toggleOptions = document.querySelectorAll('.toggle-option');
            toggleOptions.forEach(opt => opt.classList.remove('selected'));
            
            if (trade.status === 'open') {
                tradeResult = 'open';
                document.querySelector('.toggle-option.open').classList.add('selected');
                document.getElementById('profit-loss').disabled = true;
                document.getElementById('profit-loss').value = '';
            } else {
                if (trade.profitLoss > 0) {
                    tradeResult = 'win';
                    document.querySelector('.toggle-option.win').classList.add('selected');
                    document.getElementById('profit-loss').value = Math.abs(trade.profitLoss);
                } else {
                    tradeResult = 'loss';
                    document.querySelector('.toggle-option.loss').classList.add('selected');
                    document.getElementById('profit-loss').value = Math.abs(trade.profitLoss);
                }
                document.getElementById('profit-loss').disabled = false;
            }
            
            // Render confluence checkboxes with selected confluences
            ConfluenceManager.renderConfluenceCheckboxes(trade.confluences || []);
            
            updateRiskMetrics();
            
            document.getElementById('trade-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('trade-modal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function closeAllTradesModal() {
            document.getElementById('all-trades-modal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function closeHelpModal() {
            document.getElementById('help-modal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function openSettingsModal() {
            document.getElementById('settings-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function openHelpModal() {
            document.getElementById('help-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function handleTradeSubmit(e) {
            e.preventDefault();
            
            const pair = document.getElementById('pair').value;
            const type = document.getElementById('type').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const entryTime = document.getElementById('entry-time').value;
            const closeTime = document.getElementById('close-time').value;
            const category = document.getElementById('category').value;
            const notes = document.getElementById('notes').value;
            const selectedConfluences = ConfluenceManager.getSelectedConfluences();
            const confluenceScore = ConfluenceManager.calculateConfluenceScore(selectedConfluences);
            
            let profitLoss = null;
            const profitLossAmount = parseFloat(document.getElementById('profit-loss').value) || 0;
            
            if (tradeResult === 'win') {
                profitLoss = profitLossAmount;
            } else if (tradeResult === 'loss') {
                profitLoss = -profitLossAmount;
            }
            
            const entryDate = entryTime.split('T')[0];
            const status = (closeTime && tradeResult !== 'open') ? 'closed' : 'open';
            const displayDate = status === 'closed' && closeTime ? closeTime.split('T')[0] : entryDate;
            
            const tradeData = {
                pair,
                type,
                amount,
                entryTime,
                closeTime,
                profitLoss,
                date: displayDate,
                entryDate: entryDate,
                status,
                category,
                notes,
                confluences: selectedConfluences,
                confluenceScore
            };
            
            if (!Validation.validateTradeForm(tradeData)) {
                Validation.showErrors();
                return;
            }
            
            // Show loading state
            document.getElementById('trade-modal-loading').classList.add('show');
            document.getElementById('save-trade-btn').disabled = true;
            document.getElementById('save-trade-text').innerHTML = '<div class="loading-spinner"></div> Saving...';
            
            setTimeout(() => {
                if (editingTradeId) {
                    TradeManager.updateTrade(editingTradeId, tradeData);
                    ToastManager.show('Trade updated successfully', 'success');
                } else {
                    TradeManager.addTrade(tradeData);
                    ToastManager.show('Trade added successfully', 'success');
                }
                
                // Update UI
                renderCalendar();
                updateStats();
                renderRecentTrades();
                ChartManager.updateChart();
                updateMonthlySummary();
                
                // If a day is selected, update its summary
                if (selectedDay) {
                    const day = new Date(selectedDay).getDate();
                    showDaySummary(selectedDay, day);
                }
                
                // Close modal
                closeModal();
                
                // Reset loading state
                document.getElementById('trade-modal-loading').classList.remove('show');
                document.getElementById('save-trade-btn').disabled = false;
                document.getElementById('save-trade-text').textContent = 'Save Trade';
            }, 800);
        }

        function deleteTrade(tradeId) {
            if (confirm('Are you sure you want to delete this trade?')) {
                TradeManager.deleteTrade(tradeId);
                ToastManager.show('Trade deleted successfully', 'success');
                
                renderCalendar();
                updateStats();
                renderRecentTrades();
                ChartManager.updateChart();
                updateMonthlySummary();
                renderAllTradesList();
                
                if (selectedDay) {
                    const day = new Date(selectedDay).getDate();
                    showDaySummary(selectedDay, day);
                }
            }
        }

        // Stats functions
        function updateStats() {
            const stats = TradeManager.getTradeStats();
            
            document.getElementById('total-profit').textContent = `${stats.totalProfit >= 0 ? '+' : ''}$${stats.totalProfit.toFixed(2)}`;
            document.getElementById('total-profit').className = `stat-value ${stats.totalProfit >= 0 ? 'positive-stat' : 'negative-stat'}`;
            
            document.getElementById('win-rate').textContent = `${stats.winRate}%`;
            document.getElementById('total-trades').textContent = stats.totalTrades;
            document.getElementById('profit-factor').textContent = stats.profitFactor;
            document.getElementById('risk-reward').textContent = stats.avgRiskReward;
        }

        // Recent trades functions
        function showRecentTrades() {
            document.getElementById('right-panel-title').textContent = 'Recent Trades';
            renderRecentTrades();
        }

        function renderRecentTrades() {
            const rightPanelContent = document.getElementById('right-panel-content');
            rightPanelContent.innerHTML = '';
            
            if (TradeManager.trades.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'trade-item';
                emptyState.innerHTML = `
                    <div class="trade-info">
                        <div class="trade-pair">No trades yet</div>
                    </div>
                `;
                rightPanelContent.appendChild(emptyState);
                return;
            }
            
            const sortedTrades = [...TradeManager.trades].sort((a, b) => {
                const dateA = a.status === 'closed' && a.closeTime ? new Date(a.closeTime) : new Date(a.entryTime);
                const dateB = b.status === 'closed' && b.closeTime ? new Date(b.closeTime) : new Date(b.entryTime);
                return dateB - dateA;
            }).slice(0, 5);
            
            sortedTrades.forEach(trade => {
                const tradeEl = document.createElement('div');
                tradeEl.className = 'trade-item';
                tradeEl.setAttribute('data-trade-id', trade.id);
                
                const profitLossDisplay = trade.status === 'open' ? 
                    'Open' : 
                    `${trade.profitLoss >= 0 ? '+' : ''}$${trade.profitLoss.toFixed(2)}`;
                
                const tradeDate = trade.status === 'closed' && trade.closeTime ? 
                    new Date(trade.closeTime) : new Date(trade.entryTime);
                const formattedDate = `${tradeDate.getMonth() + 1}/${tradeDate.getDate()}/${tradeDate.getFullYear()}`;
                
                const categoryClass = trade.category ? `category-${trade.category}` : '';
                const categoryName = trade.category ? trade.category.charAt(0).toUpperCase() + trade.category.slice(1) : '';
                const confluenceScore = trade.confluenceScore || 0;
                const scoreClass = confluenceScore >= 80 ? 'high' : confluenceScore >= 50 ? 'medium' : 'low';
                
                tradeEl.innerHTML = `
                    <div class="trade-info">
                        <div class="trade-pair">${trade.pair} ${trade.category ? `<span class="category-badge ${categoryClass}">${categoryName}</span>` : ''}</div>
                        <div class="trade-date">${formattedDate} <span class="confluence-score ${scoreClass}" style="margin-left: 5px;">${confluenceScore}%</span></div>
                    </div>
                    <div class="trade-profit ${trade.status === 'closed' ? (trade.profitLoss >= 0 ? 'positive' : 'negative') : ''}">
                        ${profitLossDisplay}
                    </div>
                `;
                
                rightPanelContent.appendChild(tradeEl);
            });
            
            // Add click event listeners to trade items
            document.querySelectorAll('.trade-item[data-trade-id]').forEach(item => {
                item.addEventListener('click', function() {
                    const tradeId = parseInt(this.getAttribute('data-trade-id'));
                    showTradeDetails(tradeId);
                });
            });
        }

        // All trades functions
        function openAllTradesModal() {
            renderAllTradesList();
            document.getElementById('all-trades-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function renderAllTradesList() {
            const allTradesList = document.getElementById('all-trades-list');
            allTradesList.innerHTML = '';
            selectedTradeIds.clear();
            updateSelectedCount();
            
            if (TradeManager.trades.length === 0) {
                allTradesList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--neutral-color);">No trades recorded yet.</p>';
                document.getElementById('filtered-trade-count').textContent = 'Showing 0 of 0 trades';
                return;
            }
            
            const sortedTrades = [...TradeManager.trades].sort((a, b) => {
                const dateA = a.status === 'closed' && a.closeTime ? new Date(a.closeTime) : new Date(a.entryTime);
                const dateB = b.status === 'closed' && b.closeTime ? new Date(b.closeTime) : new Date(b.entryTime);
                return dateB - dateA;
            });
            
            sortedTrades.forEach(trade => {
                const tradeEl = document.createElement('div');
                tradeEl.className = 'trade-management-item';
                
                const tradeDate = trade.status === 'closed' && trade.closeTime ? 
                    new Date(trade.closeTime) : new Date(trade.entryTime);
                const formattedDate = `${tradeDate.getMonth() + 1}/${tradeDate.getDate()}/${tradeDate.getFullYear()}`;
                
                const categoryClass = trade.category ? `category-${trade.category}` : '';
                const categoryName = trade.category ? trade.category.charAt(0).toUpperCase() + trade.category.slice(1) : '';
                const confluenceScore = trade.confluenceScore || 0;
                const scoreClass = confluenceScore >= 80 ? 'high' : confluenceScore >= 50 ? 'medium' : 'low';
                
                tradeEl.innerHTML = `
                    <div class="trade-management-info">
                        <input type="checkbox" class="trade-checkbox" value="${trade.id}">
                        <div class="trade-management-pair">${trade.pair} ${trade.category ? `<span class="category-badge ${categoryClass}">${categoryName}</span>` : ''}</div>
                        <div class="trade-management-type ${trade.type.toLowerCase()}">${trade.type}</div>
                        <div class="trade-management-date">${formattedDate}</div>
                        <div class="trade-management-amount">$${trade.amount.toFixed(2)}</div>
                        <div class="trade-profit ${trade.status === 'closed' ? (trade.profitLoss >= 0 ? 'positive' : 'negative') : ''}">
                            ${trade.status === 'open' ? 'Open' : (trade.profitLoss >= 0 ? '+' : '') + '$' + trade.profitLoss.toFixed(2)}
                            <span class="confluence-score ${scoreClass}" style="margin-left: 5px;">${confluenceScore}%</span>
                        </div>
                    </div>
                    <div class="trade-management-actions">
                        <button class="action-btn edit-btn" data-id="${trade.id}">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="action-btn delete-btn" data-id="${trade.id}">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;
                
                allTradesList.appendChild(tradeEl);
            });
            
            // Add event listeners to checkboxes
            allTradesList.querySelectorAll('.trade-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const tradeId = parseInt(this.value);
                    if (this.checked) {
                        selectedTradeIds.add(tradeId);
                    } else {
                        selectedTradeIds.delete(tradeId);
                    }
                    updateSelectedCount();
                    updateSelectAllCheckbox();
                });
            });
            
            // Add event listeners to edit and delete buttons
            allTradesList.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tradeId = parseInt(this.getAttribute('data-id'));
                    closeAllTradesModal();
                    openEditTradeModal(tradeId);
                });
            });
            
            allTradesList.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tradeId = parseInt(this.getAttribute('data-id'));
                    deleteTrade(tradeId);
                });
            });
            
            document.getElementById('filtered-trade-count').textContent = `Showing ${sortedTrades.length} of ${TradeManager.trades.length} trades`;
        }

        // Bulk selection functions
        function selectAllTrades() {
            selectedTradeIds.clear();
            TradeManager.trades.forEach(trade => {
                selectedTradeIds.add(trade.id);
            });
            updateSelectedCount();
            updateCheckboxes();
        }

        function deselectAllTrades() {
            selectedTradeIds.clear();
            updateSelectedCount();
            updateCheckboxes();
        }

        function deleteSelectedTrades() {
            if (selectedTradeIds.size === 0) {
                ToastManager.show('Please select at least one trade to delete.', 'warning');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${selectedTradeIds.size} selected trade(s)? This action cannot be undone.`)) {
                TradeManager.deleteMultipleTrades([...selectedTradeIds]);
                ToastManager.show(`Successfully deleted ${selectedTradeIds.size} trade(s).`, 'success');
                
                selectedTradeIds.clear();
                updateSelectedCount();
                
                renderCalendar();
                updateStats();
                renderRecentTrades();
                ChartManager.updateChart();
                updateMonthlySummary();
                renderAllTradesList();
            }
        }

        function deleteAllTrades() {
            if (TradeManager.trades.length === 0) {
                ToastManager.show('No trades to delete.', 'warning');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ALL ${TradeManager.trades.length} trades? This action cannot be undone.`)) {
                TradeManager.trades = [];
                TradeManager.saveTrades();
                
                selectedTradeIds.clear();
                updateSelectedCount();
                
                renderCalendar();
                updateStats();
                renderRecentTrades();
                ChartManager.updateChart();
                updateMonthlySummary();
                renderAllTradesList();
                
                ToastManager.show('All trades have been deleted.', 'success');
            }
        }

        function toggleSelectAll() {
            if (document.getElementById('select-all-checkbox').checked) {
                selectAllTrades();
            } else {
                deselectAllTrades();
            }
        }

        function updateSelectedCount() {
            document.getElementById('selected-count').textContent = `${selectedTradeIds.size} selected`;
        }

        function updateCheckboxes() {
            const checkboxes = document.querySelectorAll('.trade-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectedTradeIds.has(parseInt(checkbox.value));
            });
            updateSelectAllCheckbox();
        }

        function updateSelectAllCheckbox() {
            const allSelected = TradeManager.trades.length > 0 && selectedTradeIds.size === TradeManager.trades.length;
            const someSelected = selectedTradeIds.size > 0 && selectedTradeIds.size < TradeManager.trades.length;
            
            document.getElementById('select-all-checkbox').checked = allSelected;
            document.getElementById('select-all-checkbox').indeterminate = someSelected;
        }

        // Monthly summary functions
        function updateMonthlySummary() {
            const monthTrades = TradeManager.trades.filter(trade => {
                const tradeDate = new Date(trade.status === 'closed' && trade.closeTime ? trade.closeTime : trade.entryTime);
                return tradeDate.getMonth() === currentMonth && tradeDate.getFullYear() === currentYear;
            });
            
            const closedMonthTrades = monthTrades.filter(trade => trade.status === 'closed');
            const monthlyProfit = closedMonthTrades.reduce((sum, trade) => sum + trade.profitLoss, 0);
            const winningMonthTrades = closedMonthTrades.filter(trade => trade.profitLoss > 0).length;
            const monthlyWinRate = closedMonthTrades.length > 0 ? Math.round((winningMonthTrades / closedMonthTrades.length) * 100) : 0;
            
            const monthlyWins = closedMonthTrades.filter(t => t.profitLoss > 0).reduce((sum, t) => sum + t.profitLoss, 0);
            const monthlyLosses = Math.abs(closedMonthTrades.filter(t => t.profitLoss < 0).reduce((sum, t) => sum + t.profitLoss, 0));
            const monthlyProfitFactor = monthlyLosses > 0 ? (monthlyWins / monthlyLosses).toFixed(2) : monthlyWins > 0 ? '' : '0.00';
            
            document.getElementById('monthly-profit').textContent = `${monthlyProfit >= 0 ? '+' : ''}$${monthlyProfit.toFixed(2)}`;
            document.getElementById('monthly-profit').className = `summary-value ${monthlyProfit >= 0 ? 'positive-stat' : 'negative-stat'}`;
            
            document.getElementById('monthly-trades').textContent = monthTrades.length;
            document.getElementById('monthly-win-rate').textContent = `${monthlyWinRate}%`;
            document.getElementById('monthly-profit-factor').textContent = monthlyProfitFactor;
        }

        // Settings functions
        function toggleDarkMode() {
            settings.darkMode = document.getElementById('dark-mode-toggle').checked;
            SettingsManager.updateSetting('darkMode', settings.darkMode);
            
            if (settings.darkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            
            ChartManager.updateChart();
        }

        function handleSaveBalance() {
            const balance = parseFloat(document.getElementById('initial-balance').value);
            if (!isNaN(balance) && balance >= 0) {
                settings.initialBalance = balance;
                if (SettingsManager.updateSetting('initialBalance', balance)) {
                    ToastManager.show('Initial balance updated successfully!', 'success');
                    updateStats();
                    ChartManager.updateChart();
                }
            } else {
                ToastManager.show('Please enter a valid balance amount.', 'error');
            }
        }

        function handleExportExcel() {
            if (TradeManager.trades.length === 0) {
                ToastManager.show('No trades to export.', 'warning');
                return;
            }
            
            const exportData = TradeManager.trades.map(trade => ({
                'Trade ID': trade.id,
                'Pair': trade.pair,
                'Type': trade.type,
                'Amount Risked': trade.amount,
                'Entry Time': trade.entryTime,
                'Close Time': trade.closeTime || 'Open',
                'Profit/Loss': trade.profitLoss || 'Open',
                'Status': trade.status,
                'Category': trade.category || '',
                'Confluences': (trade.confluences || []).map(id => {
                    const confluence = ConfluenceManager.confluences.find(c => c.id === id);
                    return confluence ? confluence.name : 'Unknown';
                }).join(', '),
                'Confluence Score': trade.confluenceScore || 0,
                'Notes': trade.notes || '',
                'Entry Date': trade.entryDate,
                'Display Date': trade.date
            }));
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Trades');
            
            const fileName = `TradeJournal_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            ToastManager.show('Trades exported successfully!', 'success');
        }

        function handleImportExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const importStatus = document.getElementById('import-status');
            importStatus.textContent = 'Importing...';
            importStatus.style.color = 'var(--neutral-color)';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (jsonData.length === 0) {
                        importStatus.textContent = 'No data found in file.';
                        importStatus.style.color = 'var(--loss-color)';
                        return;
                    }
                    
                    let importedCount = 0;
                    let skippedCount = 0;
                    
                    jsonData.forEach(row => {
                        if (!row.Pair || !row.Type || row['Amount Risked'] === undefined) {
                            skippedCount++;
                            return;
                        }
                        
                        const hasCloseTime = row['Close Time'] && row['Close Time'] !== 'Open';
                        const hasProfitLoss = row['Profit/Loss'] !== undefined && row['Profit/Loss'] !== 'Open';
                        const status = hasCloseTime && hasProfitLoss ? 'closed' : 'open';
                        
                        let displayDate;
                        if (row['Display Date']) {
                            displayDate = row['Display Date'];
                        } else if (hasCloseTime) {
                            displayDate = new Date(row['Close Time']).toISOString().split('T')[0];
                        } else {
                            displayDate = new Date(row['Entry Time']).toISOString().split('T')[0];
                        }
                        
                        // Parse confluences from string to array of IDs
                        let confluences = [];
                        if (row.Confluences) {
                            const confluenceNames = row.Confluences.split(', ');
                            confluences = confluenceNames.map(name => {
                                const confluence = ConfluenceManager.confluences.find(c => c.name === name);
                                return confluence ? confluence.id : null;
                            }).filter(id => id !== null);
                        }
                        
                        const trade = {
                            id: TradeManager.trades.length > 0 ? Math.max(...TradeManager.trades.map(t => t.id)) + 1 : 1,
                            pair: row.Pair,
                            type: row.Type,
                            amount: parseFloat(row['Amount Risked']),
                            entryTime: row['Entry Time'],
                            closeTime: hasCloseTime ? row['Close Time'] : '',
                            profitLoss: hasProfitLoss ? parseFloat(row['Profit/Loss']) : null,
                            date: displayDate,
                            entryDate: new Date(row['Entry Time']).toISOString().split('T')[0],
                            status: status,
                            category: row.Category || 'day',
                            notes: row.Notes || '',
                            confluences: confluences,
                            confluenceScore: row['Confluence Score'] || 0
                        };
                        
                        TradeManager.trades.push(trade);
                        importedCount++;
                    });
                    
                    TradeManager.saveTrades();
                    
                    renderCalendar();
                    updateStats();
                    renderRecentTrades();
                    ChartManager.updateChart();
                    updateMonthlySummary();
                    
                    importStatus.textContent = `Successfully imported ${importedCount} trades. ${skippedCount} rows skipped.`;
                    importStatus.style.color = 'var(--profit-color)';
                    
                    document.getElementById('import-excel').value = '';
                    ToastManager.show(`Imported ${importedCount} trades successfully!`, 'success');
                    
                } catch (error) {
                    console.error('Import error:', error);
                    importStatus.textContent = 'Error importing file. Please check the format.';
                    importStatus.style.color = 'var(--loss-color)';
                    ToastManager.show('Error importing file. Please check the format.', 'error');
                }
            };
            
            reader.onerror = function() {
                importStatus.textContent = 'Error reading file.';
                importStatus.style.color = 'var(--loss-color)';
                ToastManager.show('Error reading file.', 'error');
            };
            
            reader.readAsArrayBuffer(file);
        }

        function handleCreateBackup() {
            if (TradeManager.trades.length === 0) {
                ToastManager.show('No trades to backup.', 'warning');
                return;
            }
            
            const password = document.getElementById('backup-password').value;
            const encryptedData = Security.encrypt({
                trades: TradeManager.trades,
                settings: settings,
                confluences: ConfluenceManager.confluences,
                backupDate: new Date().toISOString()
            }, password);
            
            const blob = new Blob([encryptedData], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tradetracker_backup_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            ToastManager.show('Backup created successfully!', 'success');
        }

        // Search and filter functions
        function handleTradeSearch() {
            const searchTerm = document.getElementById('trade-search').value.toLowerCase();
            filterTrades();
        }

        function handleTradeFilter() {
            filterTrades();
        }

        function filterTrades() {
            const searchTerm = document.getElementById('trade-search').value.toLowerCase();
            const filterValue = document.getElementById('trade-filter').value;
            
            const filteredTrades = TradeManager.trades.filter(trade => {
                // Search filter
                const matchesSearch = trade.pair.toLowerCase().includes(searchTerm) || 
                                    (trade.notes && trade.notes.toLowerCase().includes(searchTerm));
                
                // Category/status filter
                let matchesFilter = true;
                if (filterValue !== 'all') {
                    if (filterValue === 'win') {
                        matchesFilter = trade.status === 'closed' && trade.profitLoss > 0;
                    } else if (filterValue === 'loss') {
                        matchesFilter = trade.status === 'closed' && trade.profitLoss < 0;
                    } else if (filterValue === 'open') {
                        matchesFilter = trade.status === 'open';
                    } else {
                        matchesFilter = trade.category === filterValue;
                    }
                }
                
                return matchesSearch && matchesFilter;
            });
            
            // Update the display with filtered trades
            document.getElementById('filtered-trade-count').textContent = `Showing ${filteredTrades.length} of ${TradeManager.trades.length} trades`;
            
            // Note: In a full implementation, we would update the trades list display
            // This is a simplified version for demonstration
        }

        // Utility functions
        function formatTime(dateTimeStr) {
            if (!dateTimeStr) return '';
            const date = new Date(dateTimeStr);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '';
            const date = new Date(dateTimeStr);
            return date.toLocaleString();
        }

        // Initialize with recent trades view
        showRecentTrades();
    </script>
</body>
</html>
