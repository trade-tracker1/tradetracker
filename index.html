<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeTracker Calendar</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --bg-color: #f5f7fa;
            --text-color: #333;
            --card-bg: white;
            --border-color: #e1e4e8;
            --header-bg: #edf2f7;
            --primary-color: #3a86ff;
            --profit-color: #10b981;
            --loss-color: #ef4444;
            --neutral-color: #718096;
            --prev-month-color: #a0aec0;
        }
        
        .dark-mode {
            --bg-color: #1a202c;
            --text-color: #e2e8f0;
            --card-bg: #2d3748;
            --border-color: #4a5568;
            --header-bg: #2d3748;
            --primary-color: #4299e1;
            --profit-color: #48bb78;
            --loss-color: #f56565;
            --neutral-color: #a0aec0;
            --prev-month-color: #4a5568;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 15px;
            transition: background-color 0.3s, color 0.3s;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .logo i {
            font-size: 22px;
            color: var(--primary-color);
        }
        
        .logo h1 {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .month-nav {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            flex: 1;
        }
        
        .month-nav button {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: var(--neutral-color);
            padding: 8px 12px;
            border-radius: 5px;
            transition: background-color 0.2s;
            min-width: 44px;
            min-height: 44px;
        }
        
        .month-nav button:hover {
            background-color: var(--header-bg);
        }
        
        .month-year {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            min-width: 160px;
            text-align: center;
        }
        
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 25px;
        }
        
        .day-header {
            text-align: center;
            padding: 12px 5px;
            font-weight: 600;
            color: var(--neutral-color);
            background-color: var(--header-bg);
            border-radius: 5px;
            font-size: 14px;
        }
        
        .day {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 10px 8px;
            min-height: 100px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .day:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .day-number {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-color);
            font-size: 16px;
            line-height: 1.2;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .prev-month-day {
            color: var(--prev-month-color);
            opacity: 0.6;
        }
        
        .day-header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
        }
        
        .profit {
            color: var(--profit-color);
            font-weight: 600;
            font-size: 14px;
            line-height: 1.2;
        }
        
        .loss {
            color: var(--loss-color);
            font-weight: 600;
            font-size: 14px;
            line-height: 1.2;
        }
        
        .add-trade-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            min-width: 24px;
            min-height: 24px;
            flex-shrink: 0;
            margin-left: 5px;
        }
        
        /* Monthly Analysis Section */
        .monthly-analysis {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .monthly-analysis h2 {
            margin-bottom: 20px;
            color: var(--text-color);
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .monthly-analysis h2 i {
            color: var(--primary-color);
        }
        
        .analysis-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .analysis-stat {
            text-align: center;
            padding: 15px;
            background-color: var(--header-bg);
            border-radius: 8px;
        }
        
        .analysis-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .analysis-label {
            color: var(--neutral-color);
            font-size: 14px;
        }
        
        .analysis-positive {
            color: var(--profit-color);
        }
        
        .analysis-negative {
            color: var(--loss-color);
        }
        
        .analysis-neutral {
            color: var(--primary-color);
        }
        
        .analysis-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .breakdown-item {
            padding: 15px;
            background-color: var(--header-bg);
            border-radius: 8px;
        }
        
        .breakdown-item h3 {
            margin-bottom: 10px;
            font-size: 16px;
            color: var(--text-color);
        }
        
        .breakdown-list {
            list-style: none;
        }
        
        .breakdown-list li {
            padding: 5px 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
        }
        
        .breakdown-list li:last-child {
            border-bottom: none;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 15px;
            overflow-y: auto;
        }
        
        .modal-content {
            background-color: var(--card-bg);
            border-radius: 10px;
            width: 100%;
            max-width: 500px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background-color: var(--card-bg);
            z-index: 1;
        }
        
        .modal-header h2 {
            font-size: 20px;
            color: var(--text-color);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--neutral-color);
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--neutral-color);
            font-size: 14px;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 16px;
            background-color: var(--card-bg);
            color: var(--text-color);
            -webkit-appearance: none;
        }
        
        .form-row {
            display: flex;
            gap: 12px;
            flex-direction: column;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .btn {
            padding: 12px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
            font-size: 16px;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2563eb;
        }
        
        .btn-secondary {
            background-color: var(--header-bg);
            color: var(--text-color);
        }
        
        .btn-secondary:hover {
            background-color: var(--border-color);
        }
        
        .btn-danger {
            background-color: var(--loss-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #dc2626;
        }
        
        .btn-success {
            background-color: var(--profit-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #0da271;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .trades-list {
            margin-top: 25px;
        }
        
        .trades-list h2 {
            margin-bottom: 15px;
            color: var(--text-color);
            font-size: 20px;
        }
        
        .trade-item {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-direction: column;
            gap: 10px;
        }
        
        .trade-info {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            flex-wrap: wrap;
            width: 100%;
        }
        
        .trade-pair {
            font-weight: 600;
            color: var(--text-color);
            font-size: 16px;
        }
        
        .trade-type {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .trade-type.buy {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .trade-type.sell {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .trade-amount {
            color: var(--neutral-color);
            font-size: 14px;
        }
        
        .trade-profit {
            font-weight: 600;
            font-size: 16px;
            align-self: flex-end;
        }
        
        .trade-profit.positive {
            color: var(--profit-color);
        }
        
        .trade-profit.negative {
            color: var(--loss-color);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--neutral-color);
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            color: var(--border-color);
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: var(--neutral-color);
            font-size: 14px;
        }
        
        .positive-stat {
            color: var(--profit-color);
        }
        
        .negative-stat {
            color: var(--loss-color);
        }
        
        .neutral-stat {
            color: var(--primary-color);
        }
        
        .day-trades-modal {
            max-width: 700px;
        }
        
        .day-trades-list {
            max-height: 60vh;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .day-trade-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            flex-direction: column;
            gap: 12px;
        }
        
        .day-trade-item:last-child {
            border-bottom: none;
        }
        
        .day-trade-actions {
            display: flex;
            gap: 10px;
            align-self: flex-end;
        }
        
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            padding: 8px 12px;
            border-radius: 5px;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .edit-btn {
            color: var(--primary-color);
            background-color: var(--header-bg);
        }
        
        .delete-btn {
            color: var(--loss-color);
            background-color: var(--header-bg);
        }
        
        .open-trade-badge {
            background-color: #fbbf24;
            color: #92400e;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 5px;
        }
        
        .settings-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: var(--neutral-color);
            padding: 10px;
            border-radius: 5px;
            transition: background-color 0.2s;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .settings-btn:hover {
            background-color: var(--header-bg);
        }
        
        .balance-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-direction: column;
        }
        
        .balance-input input {
            flex: 1;
        }
        
        .chart-container {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            position: relative;
            height: 300px;
        }
        
        .chart-wrapper {
            position: relative;
            height: 250px;
            width: 100%;
        }
        
        .chart-title {
            margin-bottom: 15px;
            color: var(--text-color);
            font-size: 18px;
        }
        
        .theme-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 15px;
            padding: 15px 0;
            border-top: 1px solid var(--border-color);
        }
        
        .theme-toggle label {
            color: var(--neutral-color);
            font-size: 16px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .export-btn {
            background-color: var(--profit-color);
            color: white;
            margin-top: 15px;
            width: 100%;
        }
        
        .export-btn:hover {
            background-color: #0da271;
        }
        
        .import-btn {
            background-color: var(--primary-color);
            color: white;
            margin-top: 15px;
        }
        
        .import-btn:hover {
            background-color: #2563eb;
        }
        
        .file-input {
            display: none;
        }
        
        .file-input-label {
            display: block;
            padding: 12px 16px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            margin-top: 10px;
            transition: background-color 0.2s;
            font-size: 16px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .file-input-label:hover {
            background-color: #2563eb;
        }
        
        .multi-day-badge {
            background-color: #8b5cf6;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 5px;
        }
        
        .trade-count {
            font-size: 11px;
            color: var(--neutral-color);
            margin-top: 5px;
            line-height: 1.2;
        }
        
        /* Bulk Delete Styles */
        .bulk-delete-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        
        .bulk-delete-section h3 {
            margin-bottom: 15px;
            color: var(--text-color);
            font-size: 18px;
        }
        
        .bulk-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .bulk-actions .btn {
            flex: 1;
            min-width: 120px;
        }
        
        .trades-management-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 10px;
            background-color: var(--header-bg);
        }
        
        .trade-management-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            gap: 10px;
        }
        
        .trade-management-item:last-child {
            border-bottom: none;
        }
        
        .trade-management-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .trade-management-info {
            flex: 1;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }
        
        .trade-management-pair {
            font-weight: 600;
            color: var(--text-color);
        }
        
        .trade-management-date {
            font-size: 12px;
            color: var(--neutral-color);
        }
        
        .trade-management-profit {
            font-weight: 600;
            margin-left: auto;
        }
        
        .trade-management-profit.positive {
            color: var(--profit-color);
        }
        
        .trade-management-profit.negative {
            color: var(--loss-color);
        }
        
        .no-trades-message {
            text-align: center;
            padding: 20px;
            color: var(--neutral-color);
            font-style: italic;
        }
        
        .select-all-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: var(--card-bg);
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .select-all-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .selected-count {
            font-size: 14px;
            color: var(--neutral-color);
        }
        
        /* Chart diagonal labels */
        .diagonal-labels {
            transform: rotate(-45deg);
            transform-origin: top left;
            white-space: nowrap;
        }
        
        /* Mobile-specific styles */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .calendar {
                gap: 4px;
            }
            
            .day {
                min-height: 90px;
                padding: 8px 6px;
            }
            
            .day-header {
                padding: 10px 4px;
                font-size: 12px;
            }
            
            .day-number {
                font-size: 14px;
            }
            
            .profit, .loss {
                font-size: 12px;
            }
            
            .add-trade-btn {
                width: 22px;
                height: 22px;
                font-size: 11px;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .stat-card {
                padding: 15px 10px;
            }
            
            .stat-value {
                font-size: 16px;
            }
            
            .stat-label {
                font-size: 12px;
            }
            
            .monthly-analysis {
                padding: 15px;
            }
            
            .analysis-stats {
                grid-template-columns: 1fr;
            }
            
            .analysis-breakdown {
                grid-template-columns: 1fr;
            }
            
            .analysis-value {
                font-size: 20px;
            }
            
            .modal-content {
                padding: 15px;
                margin: 10px;
            }
            
            .modal-footer {
                flex-direction: column;
            }
            
            .modal-footer .btn {
                width: 100%;
            }
            
            .trade-item {
                padding: 12px;
            }
            
            .trade-info {
                gap: 8px;
            }
            
            .chart-container {
                height: 280px;
                padding: 15px;
            }
            
            .chart-wrapper {
                height: 230px;
            }
            
            .chart-title {
                font-size: 16px;
                margin-bottom: 12px;
            }
            
            header {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }
            
            .month-nav {
                order: 2;
            }
            
            .logo {
                justify-content: center;
                order: 1;
            }
            
            .settings-btn {
                position: absolute;
                top: 15px;
                right: 15px;
                order: 3;
            }
            
            .bulk-actions {
                flex-direction: column;
            }
            
            .bulk-actions .btn {
                width: 100%;
            }
            
            .trade-management-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
            
            .trade-management-profit {
                margin-left: 0;
            }
        }
        
        @media (min-width: 481px) and (max-width: 768px) {
            .form-row {
                flex-direction: row;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .monthly-analysis {
                padding: 18px;
            }
            
            .analysis-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .trade-item {
                flex-direction: row;
                align-items: center;
            }
            
            .day-trade-item {
                flex-direction: row;
                align-items: center;
            }
            
            .chart-container {
                height: 300px;
            }
            
            .chart-wrapper {
                height: 250px;
            }
        }
        
        @media (min-width: 769px) {
            .form-row {
                flex-direction: row;
            }
            
            .stats {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .monthly-analysis {
                padding: 25px;
            }
            
            .analysis-stats {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .trade-item {
                flex-direction: row;
                align-items: center;
            }
            
            .day-trade-item {
                flex-direction: row;
                align-items: center;
            }
            
            .balance-input {
                flex-direction: row;
            }
        }
        
        /* Touch device improvements */
        @media (hover: none) {
            .day:hover {
                transform: none;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            }
            
            .btn:hover, .settings-btn:hover, .month-nav button:hover {
                background-color: initial;
            }
            
            .btn:active, .settings-btn:active, .month-nav button:active {
                background-color: var(--header-bg);
            }
        }
        
        /* Prevent zoom on input focus for iOS */
        @media screen and (max-width: 768px) {
            input, select, textarea {
                font-size: 16px !important;
            }
        }
        
        /* Better scrolling for modals on iOS */
        .modal-content {
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                <h1>TradeTracker</h1>
            </div>
            <div class="month-nav">
                <button id="prev-month"><i class="fas fa-chevron-left"></i></button>
                <div class="month-year" id="current-month">October 2023</div>
                <button id="next-month"><i class="fas fa-chevron-right"></i></button>
            </div>
            <button class="settings-btn" id="settings-btn">
                <i class="fas fa-cog"></i>
            </button>
        </header>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value positive-stat" id="total-profit">+$0.00</div>
                <div class="stat-label">Total Profit</div>
            </div>
            <div class="stat-card">
                <div class="stat-value neutral-stat" id="win-rate">0%</div>
                <div class="stat-label">Win Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-value neutral-stat" id="total-trades">0</div>
                <div class="stat-label">Total Trades</div>
            </div>
            <div class="stat-card">
                <div class="stat-value neutral-stat" id="account-balance">$10,000</div>
                <div class="stat-label">Account Balance</div>
            </div>
        </div>
        
        <div class="chart-container">
            <h2 class="chart-title">Account Balance Over Time</h2>
            <div class="chart-wrapper">
                <canvas id="balance-chart"></canvas>
            </div>
        </div>
        
        <div class="calendar" id="calendar">
            <!-- Calendar will be generated by JavaScript -->
        </div>
        
        <!-- Monthly Analysis Section -->
        <div class="monthly-analysis" id="monthly-analysis">
            <h2><i class="fas fa-chart-pie"></i> Monthly Analysis & Briefing</h2>
            <div class="analysis-stats">
                <div class="analysis-stat">
                    <div class="analysis-value analysis-positive" id="monthly-profit">+$0.00</div>
                    <div class="analysis-label">Monthly Profit/Loss</div>
                </div>
                <div class="analysis-stat">
                    <div class="analysis-value analysis-neutral" id="monthly-trades">0</div>
                    <div class="analysis-label">Trades This Month</div>
                </div>
                <div class="analysis-stat">
                    <div class="analysis-value analysis-neutral" id="monthly-win-rate">0%</div>
                    <div class="analysis-label">Monthly Win Rate</div>
                </div>
                <div class="analysis-stat">
                    <div class="analysis-value analysis-neutral" id="best-day">$0.00</div>
                    <div class="analysis-label">Best Day</div>
                </div>
            </div>
            <div class="analysis-breakdown">
                <div class="breakdown-item">
                    <h3>Top Performing Pairs</h3>
                    <ul class="breakdown-list" id="top-pairs">
                        <li>No trades this month</li>
                    </ul>
                </div>
                <div class="breakdown-item">
                    <h3>Trade Type Distribution</h3>
                    <ul class="breakdown-list" id="trade-types">
                        <li>No trades this month</li>
                    </ul>
                </div>
                <div class="breakdown-item">
                    <h3>Daily Performance</h3>
                    <ul class="breakdown-list" id="daily-performance">
                        <li>No trades this month</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="trades-list">
            <h2>Recent Trades</h2>
            <div id="trades-container">
                <!-- Trades will be populated by JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Trade Modal -->
    <div class="modal" id="trade-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Add New Trade</h2>
                <button class="close-modal" id="close-modal">&times;</button>
            </div>
            <form id="trade-form">
                <div class="form-group">
                    <label for="pair">Trading Pair</label>
                    <input type="text" id="pair" placeholder="e.g., EUR/USD, BTC/USD" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="type">Type</label>
                        <select id="type" required>
                            <option value="BUY">BUY</option>
                            <option value="SELL">SELL</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="amount">Amount Risked ($)</label>
                        <input type="number" id="amount" placeholder="e.g., 100" min="0" step="0.01" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="entry-time">Entry Time</label>
                        <input type="datetime-local" id="entry-time" required>
                    </div>
                    <div class="form-group">
                        <label for="close-time">Close Time</label>
                        <input type="datetime-local" id="close-time">
                        <small style="color: var(--neutral-color);">Leave empty for open trades</small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="profit-loss">Profit/Loss ($)</label>
                    <input type="number" id="profit-loss" placeholder="Leave empty for open trades" step="0.01">
                    <small style="color: var(--neutral-color);">Only for closed trades</small>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancel-trade">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Trade</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Day Trades Modal -->
    <div class="modal" id="day-trades-modal">
        <div class="modal-content day-trades-modal">
            <div class="modal-header">
                <h2 id="day-trades-title">Trades for October 15, 2023</h2>
                <button class="close-modal" id="close-day-trades">&times;</button>
            </div>
            <div class="day-trades-list" id="day-trades-list">
                <!-- Day trades will be populated by JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="close-modal" id="close-settings">&times;</button>
            </div>
            <div class="form-group">
                <label for="initial-balance">Initial Account Balance ($)</label>
                <div class="balance-input">
                    <input type="number" id="initial-balance" placeholder="e.g., 10000" min="0" step="0.01">
                    <button type="button" class="btn btn-primary" id="save-balance">Save</button>
                </div>
            </div>
            <div class="theme-toggle">
                <label for="dark-mode-toggle">Dark Mode</label>
                <label class="switch">
                    <input type="checkbox" id="dark-mode-toggle">
                    <span class="slider"></span>
                </label>
            </div>
            <button type="button" class="btn btn-success export-btn" id="export-excel">
                <i class="fas fa-file-export"></i> Export to Excel
            </button>
            <label for="import-excel" class="file-input-label">
                <i class="fas fa-file-import"></i> Import from Excel
            </label>
            <input type="file" id="import-excel" class="file-input" accept=".xlsx, .xls">
            <div id="import-status" style="margin-top: 10px; font-size: 14px; color: var(--neutral-color);"></div>
            
            <!-- Bulk Delete Section -->
            <div class="bulk-delete-section">
                <h3>Manage Trades</h3>
                <div class="bulk-actions">
                    <button type="button" class="btn btn-secondary" id="select-all-trades">
                        <i class="fas fa-check-square"></i> Select All
                    </button>
                    <button type="button" class="btn btn-secondary" id="deselect-all-trades">
                        <i class="fas fa-square"></i> Deselect All
                    </button>
                    <button type="button" class="btn btn-danger" id="delete-selected-trades">
                        <i class="fas fa-trash"></i> Delete Selected
                    </button>
                    <button type="button" class="btn btn-danger" id="delete-all-trades">
                        <i class="fas fa-trash-alt"></i> Delete All
                    </button>
                </div>
                <div class="select-all-row">
                    <div class="select-all-checkbox">
                        <input type="checkbox" id="select-all-checkbox">
                        <label for="select-all-checkbox">Select All</label>
                    </div>
                    <div class="selected-count" id="selected-count">0 selected</div>
                </div>
                <div class="trades-management-list" id="trades-management-list">
                    <!-- Trades for management will be populated here -->
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Empty trades array - no default trades
        let trades = [];
        
        // App settings
        let settings = {
            initialBalance: 10000,
            darkMode: false
        };
        
        // Current date tracking
        let currentDate = new Date();
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();
        
        // Track which trade is being edited
        let editingTradeId = null;
        
        // Chart instance
        let balanceChart = null;
        
        // Selected trades for bulk operations
        let selectedTradeIds = new Set();
        
        // DOM Elements
        const calendarEl = document.getElementById('calendar');
        const currentMonthEl = document.getElementById('current-month');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const tradeModal = document.getElementById('trade-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const cancelTradeBtn = document.getElementById('cancel-trade');
        const tradeForm = document.getElementById('trade-form');
        const tradesContainer = document.getElementById('trades-container');
        const totalProfitEl = document.getElementById('total-profit');
        const winRateEl = document.getElementById('win-rate');
        const totalTradesEl = document.getElementById('total-trades');
        const accountBalanceEl = document.getElementById('account-balance');
        const dayTradesModal = document.getElementById('day-trades-modal');
        const closeDayTradesBtn = document.getElementById('close-day-trades');
        const dayTradesList = document.getElementById('day-trades-list');
        const dayTradesTitle = document.getElementById('day-trades-title');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsBtn = document.getElementById('close-settings');
        const settingsBtn = document.getElementById('settings-btn');
        const initialBalanceInput = document.getElementById('initial-balance');
        const saveBalanceBtn = document.getElementById('save-balance');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const exportExcelBtn = document.getElementById('export-excel');
        const importExcelInput = document.getElementById('import-excel');
        const importStatus = document.getElementById('import-status');
        const balanceChartCanvas = document.getElementById('balance-chart');
        
        // Monthly Analysis Elements
        const monthlyAnalysisEl = document.getElementById('monthly-analysis');
        const monthlyProfitEl = document.getElementById('monthly-profit');
        const monthlyTradesEl = document.getElementById('monthly-trades');
        const monthlyWinRateEl = document.getElementById('monthly-win-rate');
        const bestDayEl = document.getElementById('best-day');
        const topPairsEl = document.getElementById('top-pairs');
        const tradeTypesEl = document.getElementById('trade-types');
        const dailyPerformanceEl = document.getElementById('daily-performance');
        
        // Bulk delete elements
        const selectAllTradesBtn = document.getElementById('select-all-trades');
        const deselectAllTradesBtn = document.getElementById('deselect-all-trades');
        const deleteSelectedTradesBtn = document.getElementById('delete-selected-trades');
        const deleteAllTradesBtn = document.getElementById('delete-all-trades');
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const selectedCountEl = document.getElementById('selected-count');
        const tradesManagementList = document.getElementById('trades-management-list');
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            renderCalendar();
            updateStats();
            renderRecentTrades();
            updateBalanceChart();
            updateMonthlyAnalysis();
            
            // Load settings from localStorage
            const savedSettings = localStorage.getItem('tradeTrackerSettings');
            if (savedSettings) {
                settings = JSON.parse(savedSettings);
                initialBalanceInput.value = settings.initialBalance;
                darkModeToggle.checked = settings.darkMode;
                
                // Apply dark mode if enabled
                if (settings.darkMode) {
                    document.body.classList.add('dark-mode');
                }
                
                updateStats();
            }
            
            // Load trades from localStorage
            const savedTrades = localStorage.getItem('tradeTrackerTrades');
            if (savedTrades) {
                trades = JSON.parse(savedTrades);
                renderCalendar();
                updateStats();
                renderRecentTrades();
                updateBalanceChart();
                updateMonthlyAnalysis();
            }
            
            // Event listeners
            prevMonthBtn.addEventListener('click', goToPreviousMonth);
            nextMonthBtn.addEventListener('click', goToNextMonth);
            closeModalBtn.addEventListener('click', closeModal);
            cancelTradeBtn.addEventListener('click', closeModal);
            tradeForm.addEventListener('submit', saveTrade);
            closeDayTradesBtn.addEventListener('click', closeDayTradesModal);
            settingsBtn.addEventListener('click', openSettingsModal);
            closeSettingsBtn.addEventListener('click', closeSettingsModal);
            saveBalanceBtn.addEventListener('click', saveBalance);
            darkModeToggle.addEventListener('change', toggleDarkMode);
            exportExcelBtn.addEventListener('click', exportToExcel);
            importExcelInput.addEventListener('change', importFromExcel);
            
            // Bulk delete event listeners
            selectAllTradesBtn.addEventListener('click', selectAllTrades);
            deselectAllTradesBtn.addEventListener('click', deselectAllTrades);
            deleteSelectedTradesBtn.addEventListener('click', deleteSelectedTrades);
            deleteAllTradesBtn.addEventListener('click', deleteAllTrades);
            selectAllCheckbox.addEventListener('change', toggleSelectAll);
            
            // Better touch handling for mobile
            setupTouchEvents();
        });
        
        // Mobile touch improvements
        function setupTouchEvents() {
            // Prevent double-tap zoom on buttons
            document.querySelectorAll('button').forEach(button => {
                button.addEventListener('touchstart', function(e) {
                    if (e.touches.length > 1) {
                        e.preventDefault();
                    }
                });
            });
            
            // Better scrolling in modals
            document.querySelectorAll('.modal-content').forEach(modal => {
                modal.addEventListener('touchstart', function() {
                    this.classList.add('scrolling');
                });
                
                modal.addEventListener('touchend', function() {
                    this.classList.remove('scrolling');
                });
            });
        }
        
        // Calendar functions
        function renderCalendar() {
            // Clear the calendar
            calendarEl.innerHTML = '';
            
            // Add day headers
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header';
                dayHeader.textContent = day;
                calendarEl.appendChild(dayHeader);
            });
            
            // Update month/year display
            currentMonthEl.textContent = `${getMonthName(currentMonth)} ${currentYear}`;
            
            // Get first day of month and number of days
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            // Get previous month's last days
            const prevMonthLastDay = new Date(currentYear, currentMonth, 0).getDate();
            
            // Add previous month's days
            for (let i = firstDay - 1; i >= 0; i--) {
                const dayEl = document.createElement('div');
                dayEl.className = 'day prev-month-day';
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = prevMonthLastDay - i;
                dayEl.appendChild(dayNumber);
                
                calendarEl.appendChild(dayEl);
            }
            
            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'day';
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                
                // Create header row with day number and add button
                const dayHeaderRow = document.createElement('div');
                dayHeaderRow.className = 'day-header-row';
                
                const dayNumberText = document.createElement('span');
                dayNumberText.textContent = day;
                dayHeaderRow.appendChild(dayNumberText);
                
                // Add button to add new trade
                const addBtn = document.createElement('button');
                addBtn.className = 'add-trade-btn';
                addBtn.innerHTML = '<i class="fas fa-plus"></i>';
                addBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    openAddTradeModal(dateStr);
                });
                dayHeaderRow.appendChild(addBtn);
                
                dayNumber.appendChild(dayHeaderRow);
                dayEl.appendChild(dayNumber);
                
                // Format date for this day
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                // Calculate daily P&L (only for closed trades)
                const dailyTrades = trades.filter(trade => {
                    if (trade.status === 'open') {
                        // Open trades appear on entry day
                        return trade.date === dateStr;
                    } else {
                        // Closed trades appear on close day
                        const closeDate = trade.closeTime ? trade.closeTime.split('T')[0] : null;
                        return closeDate === dateStr;
                    }
                });
                
                const closedTrades = dailyTrades.filter(trade => trade.status === 'closed');
                const dailyProfitLoss = closedTrades.reduce((sum, trade) => sum + trade.profitLoss, 0);
                
                if (closedTrades.length > 0) {
                    const pnlEl = document.createElement('div');
                    pnlEl.className = dailyProfitLoss >= 0 ? 'profit' : 'loss';
                    pnlEl.textContent = dailyProfitLoss >= 0 ? `+$${dailyProfitLoss.toFixed(2)}` : `-$${Math.abs(dailyProfitLoss).toFixed(2)}`;
                    dayEl.appendChild(pnlEl);
                }
                
                // Add trade count badge if there are trades
                if (dailyTrades.length > 0) {
                    const tradeCount = document.createElement('div');
                    tradeCount.className = 'trade-count';
                    tradeCount.textContent = `${dailyTrades.length} trade${dailyTrades.length > 1 ? 's' : ''}`;
                    dayEl.appendChild(tradeCount);
                }
                
                // Click on day to view trades
                dayEl.addEventListener('click', function() {
                    viewTradesForDay(dateStr);
                });
                
                calendarEl.appendChild(dayEl);
            }
            
            // Calculate remaining cells for next month
            const totalCells = 42; // 6 rows x 7 days
            const cellsUsed = firstDay + daysInMonth;
            const nextMonthDays = totalCells - cellsUsed;
            
            // Add next month's first days
            for (let day = 1; day <= nextMonthDays; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'day prev-month-day';
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayEl.appendChild(dayNumber);
                
                calendarEl.appendChild(dayEl);
            }
            
            // Remove last row if it doesn't contain any days from current month
            removeEmptyLastRow();
        }
        
        function removeEmptyLastRow() {
            const dayElements = calendarEl.querySelectorAll('.day');
            const totalDays = dayElements.length;
            
            if (totalDays === 42) { // 6 rows
                const lastRowStart = 35; // 7 days * 5 rows
                let hasCurrentMonth = false;
                
                // Check if last row has any current month days
                for (let i = lastRowStart; i < totalDays; i++) {
                    if (!dayElements[i].classList.contains('prev-month-day')) {
                        hasCurrentMonth = true;
                        break;
                    }
                }
                
                // If no current month days in last row, remove it
                if (!hasCurrentMonth) {
                    for (let i = lastRowStart; i < totalDays; i++) {
                        dayElements[i].remove();
                    }
                }
            }
        }
        
        function goToPreviousMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
            updateMonthlyAnalysis();
        }
        
        function goToNextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
            updateMonthlyAnalysis();
        }
        
        function getMonthName(monthIndex) {
            const months = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            return months[monthIndex];
        }
        
        function getShortMonthName(monthIndex) {
            const months = [
                'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'
            ];
            return months[monthIndex];
        }
        
        // Monthly Analysis Functions
        function updateMonthlyAnalysis() {
            // Get trades for the current month
            const monthTrades = trades.filter(trade => {
                const tradeDate = new Date(trade.status === 'closed' && trade.closeTime ? trade.closeTime : trade.entryTime);
                return tradeDate.getMonth() === currentMonth && tradeDate.getFullYear() === currentYear;
            });
            
            const closedMonthTrades = monthTrades.filter(trade => trade.status === 'closed');
            const monthlyProfit = closedMonthTrades.reduce((sum, trade) => sum + trade.profitLoss, 0);
            const winningMonthTrades = closedMonthTrades.filter(trade => trade.profitLoss > 0).length;
            const monthlyWinRate = closedMonthTrades.length > 0 ? Math.round((winningMonthTrades / closedMonthTrades.length) * 100) : 0;
            
            // Update monthly stats
            monthlyProfitEl.textContent = `${monthlyProfit >= 0 ? '+' : ''}$${monthlyProfit.toFixed(2)}`;
            monthlyProfitEl.className = `analysis-value ${monthlyProfit >= 0 ? 'analysis-positive' : 'analysis-negative'}`;
            
            monthlyTradesEl.textContent = monthTrades.length;
            monthlyWinRateEl.textContent = `${monthlyWinRate}%`;
            
            // Calculate best day
            const dailyProfits = {};
            closedMonthTrades.forEach(trade => {
                const closeDate = trade.closeTime ? trade.closeTime.split('T')[0] : trade.entryTime.split('T')[0];
                if (!dailyProfits[closeDate]) {
                    dailyProfits[closeDate] = 0;
                }
                dailyProfits[closeDate] += trade.profitLoss;
            });
            
            let bestDayProfit = 0;
            Object.values(dailyProfits).forEach(profit => {
                if (profit > bestDayProfit) {
                    bestDayProfit = profit;
                }
            });
            
            bestDayEl.textContent = `$${bestDayProfit.toFixed(2)}`;
            
            // Update top performing pairs
            updateTopPairs(closedMonthTrades);
            
            // Update trade type distribution
            updateTradeTypes(monthTrades);
            
            // Update daily performance
            updateDailyPerformance(dailyProfits);
        }
        
        function updateTopPairs(trades) {
            topPairsEl.innerHTML = '';
            
            if (trades.length === 0) {
                topPairsEl.innerHTML = '<li>No trades this month</li>';
                return;
            }
            
            const pairPerformance = {};
            
            trades.forEach(trade => {
                if (!pairPerformance[trade.pair]) {
                    pairPerformance[trade.pair] = {
                        profit: 0,
                        trades: 0
                    };
                }
                pairPerformance[trade.pair].profit += trade.profitLoss;
                pairPerformance[trade.pair].trades += 1;
            });
            
            // Sort pairs by profit
            const sortedPairs = Object.entries(pairPerformance)
                .sort((a, b) => b[1].profit - a[1].profit)
                .slice(0, 5);
            
            sortedPairs.forEach(([pair, data]) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${pair}</span>
                    <span class="${data.profit >= 0 ? 'analysis-positive' : 'analysis-negative'}">
                        ${data.profit >= 0 ? '+' : ''}$${data.profit.toFixed(2)}
                    </span>
                `;
                topPairsEl.appendChild(li);
            });
        }
        
        function updateTradeTypes(trades) {
            tradeTypesEl.innerHTML = '';
            
            if (trades.length === 0) {
                tradeTypesEl.innerHTML = '<li>No trades this month</li>';
                return;
            }
            
            const typeCounts = {
                BUY: 0,
                SELL: 0
            };
            
            trades.forEach(trade => {
                typeCounts[trade.type]++;
            });
            
            Object.entries(typeCounts).forEach(([type, count]) => {
                const percentage = Math.round((count / trades.length) * 100);
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${type}</span>
                    <span>${count} (${percentage}%)</span>
                `;
                tradeTypesEl.appendChild(li);
            });
        }
        
        function updateDailyPerformance(dailyProfits) {
            dailyPerformanceEl.innerHTML = '';
            
            if (Object.keys(dailyProfits).length === 0) {
                dailyPerformanceEl.innerHTML = '<li>No trades this month</li>';
                return;
            }
            
            // Sort days by date
            const sortedDays = Object.entries(dailyProfits)
                .sort((a, b) => new Date(a[0]) - new Date(b[0]))
                .slice(0, 7); // Show last 7 days
            
            sortedDays.forEach(([date, profit]) => {
                const dateObj = new Date(date);
                const dayName = getShortMonthName(dateObj.getMonth()) + ' ' + dateObj.getDate();
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${dayName}</span>
                    <span class="${profit >= 0 ? 'analysis-positive' : 'analysis-negative'}">
                        ${profit >= 0 ? '+' : ''}$${profit.toFixed(2)}
                    </span>
                `;
                dailyPerformanceEl.appendChild(li);
            });
        }
        
        // Modal functions
        function openAddTradeModal(dateStr) {
            editingTradeId = null;
            document.getElementById('modal-title').textContent = 'Add New Trade';
            tradeForm.reset();
            
            // Set default date to the selected day
            const today = new Date();
            const defaultDate = dateStr ? new Date(dateStr) : today;
            
            // Format for datetime-local input (YYYY-MM-DDTHH:MM)
            const formatForInput = (date) => {
                return date.toISOString().slice(0, 16);
            };
            
            document.getElementById('entry-time').value = formatForInput(defaultDate);
            
            tradeModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function openEditTradeModal(tradeId) {
            editingTradeId = tradeId;
            const trade = trades.find(t => t.id === tradeId);
            
            if (!trade) return;
            
            document.getElementById('modal-title').textContent = 'Edit Trade';
            tradeForm.reset();
            
            document.getElementById('pair').value = trade.pair;
            document.getElementById('type').value = trade.type;
            document.getElementById('amount').value = trade.amount;
            document.getElementById('entry-time').value = trade.entryTime;
            
            if (trade.closeTime) {
                document.getElementById('close-time').value = trade.closeTime;
            }
            
            if (trade.profitLoss !== null) {
                document.getElementById('profit-loss').value = trade.profitLoss;
            }
            
            tradeModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function closeModal() {
            tradeModal.style.display = 'none';
            dayTradesModal.style.display = 'none';
            settingsModal.style.display = 'none';
            editingTradeId = null;
            document.body.style.overflow = 'auto';
        }
        
        function saveTrade(e) {
            e.preventDefault();
            
            const pair = document.getElementById('pair').value;
            const type = document.getElementById('type').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const entryTime = document.getElementById('entry-time').value;
            const closeTime = document.getElementById('close-time').value;
            const profitLoss = document.getElementById('profit-loss').value ? 
                parseFloat(document.getElementById('profit-loss').value) : null;
            
            // Extract date from entry time
            const entryDate = entryTime.split('T')[0];
            
            // Determine trade status
            const status = closeTime && profitLoss !== null ? 'closed' : 'open';
            
            // MODIFIED: For closed trades, use close date for calendar display
            // For open trades, use entry date
            const displayDate = status === 'closed' && closeTime ? closeTime.split('T')[0] : entryDate;
            
            if (editingTradeId) {
                // Update existing trade
                const tradeIndex = trades.findIndex(t => t.id === editingTradeId);
                if (tradeIndex !== -1) {
                    trades[tradeIndex] = {
                        ...trades[tradeIndex],
                        pair,
                        type,
                        amount,
                        entryTime,
                        closeTime,
                        profitLoss,
                        date: displayDate, // Use display date for calendar
                        entryDate: entryDate, // Store original entry date separately
                        status
                    };
                }
            } else {
                // Create new trade object
                const newTrade = {
                    id: trades.length > 0 ? Math.max(...trades.map(t => t.id)) + 1 : 1,
                    pair,
                    type,
                    amount,
                    entryTime,
                    closeTime,
                    profitLoss,
                    date: displayDate, // Use display date for calendar
                    entryDate: entryDate, // Store original entry date separately
                    status
                };
                
                // Add to trades array
                trades.push(newTrade);
            }
            
            // Save to localStorage
            localStorage.setItem('tradeTrackerTrades', JSON.stringify(trades));
            
            // Update UI
            renderCalendar();
            updateStats();
            renderRecentTrades();
            updateBalanceChart();
            updateMonthlyAnalysis();
            
            // Close modal
            closeModal();
        }
        
        function deleteTrade(tradeId) {
            if (confirm('Are you sure you want to delete this trade?')) {
                trades = trades.filter(trade => trade.id !== tradeId);
                
                // Save to localStorage
                localStorage.setItem('tradeTrackerTrades', JSON.stringify(trades));
                
                // Update UI
                renderCalendar();
                updateStats();
                renderRecentTrades();
                updateBalanceChart();
                updateMonthlyAnalysis();
                
                // Close day trades modal if open
                closeDayTradesModal();
            }
        }
        
        // Stats functions
        function updateStats() {
            const closedTrades = trades.filter(trade => trade.status === 'closed');
            const totalProfit = closedTrades.reduce((sum, trade) => sum + trade.profitLoss, 0);
            const winningTrades = closedTrades.filter(trade => trade.profitLoss > 0).length;
            const winRate = closedTrades.length > 0 ? Math.round((winningTrades / closedTrades.length) * 100) : 0;
            
            totalProfitEl.textContent = `${totalProfit >= 0 ? '+' : ''}$${totalProfit.toFixed(2)}`;
            totalProfitEl.className = `stat-value ${totalProfit >= 0 ? 'positive-stat' : 'negative-stat'}`;
            
            winRateEl.textContent = `${winRate}%`;
            totalTradesEl.textContent = trades.length;
            
            // Calculate account balance
            const accountBalance = settings.initialBalance + totalProfit;
            accountBalanceEl.textContent = `$${accountBalance.toFixed(2)}`;
        }
        
        // Trades list functions
        function renderRecentTrades() {
            tradesContainer.innerHTML = '';
            
            if (trades.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.innerHTML = `
                    <i class="fas fa-chart-bar"></i>
                    <p>No trades recorded yet. Add your first trade to get started!</p>
                `;
                tradesContainer.appendChild(emptyState);
                return;
            }
            
            // Sort trades by date (newest first) and take the 5 most recent
            const sortedTrades = [...trades].sort((a, b) => {
                // For closed trades, sort by close time; for open trades, sort by entry time
                const dateA = a.status === 'closed' && a.closeTime ? new Date(a.closeTime) : new Date(a.entryTime);
                const dateB = b.status === 'closed' && b.closeTime ? new Date(b.closeTime) : new Date(b.entryTime);
                return dateB - dateA;
            }).slice(0, 5);
            
            sortedTrades.forEach(trade => {
                const tradeEl = document.createElement('div');
                tradeEl.className = 'trade-item';
                
                const profitLossDisplay = trade.status === 'open' ? 
                    'Open' : 
                    `${trade.profitLoss >= 0 ? '+' : ''}$${trade.profitLoss.toFixed(2)}`;
                
                // Check if trade is multi-day
                const isMultiDay = trade.entryDate && trade.date !== trade.entryDate;
                
                tradeEl.innerHTML = `
                    <div class="trade-info">
                        <div class="trade-pair">${trade.pair} 
                            ${trade.status === 'open' ? '<span class="open-trade-badge">OPEN</span>' : ''}
                            ${isMultiDay ? '<span class="multi-day-badge">MULTI-DAY</span>' : ''}
                        </div>
                        <div class="trade-type ${trade.type.toLowerCase()}">${trade.type}</div>
                        <div class="trade-amount">$${trade.amount.toFixed(2)}</div>
                    </div>
                    <div class="trade-profit ${trade.status === 'closed' ? (trade.profitLoss >= 0 ? 'positive' : 'negative') : ''}">
                        ${profitLossDisplay}
                    </div>
                `;
                
                tradesContainer.appendChild(tradeEl);
            });
        }
        
        function viewTradesForDay(dateStr) {
            // MODIFIED: Show trades that were closed on this day, or open trades that were entered on this day
            const dayTrades = trades.filter(trade => {
                if (trade.status === 'open') {
                    // Open trades appear on entry day
                    return trade.entryDate === dateStr;
                } else {
                    // Closed trades appear on close day
                    const closeDate = trade.closeTime ? trade.closeTime.split('T')[0] : null;
                    return closeDate === dateStr;
                }
            });
            
            const dateObj = new Date(dateStr);
            const formattedDate = `${getMonthName(dateObj.getMonth())} ${dateObj.getDate()}, ${dateObj.getFullYear()}`;
            
            dayTradesTitle.textContent = `Trades for ${formattedDate}`;
            dayTradesList.innerHTML = '';
            
            if (dayTrades.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.innerHTML = `
                    <i class="fas fa-chart-bar"></i>
                    <p>No trades recorded for this day.</p>
                `;
                dayTradesList.appendChild(emptyState);
            } else {
                dayTrades.forEach(trade => {
                    const tradeEl = document.createElement('div');
                    tradeEl.className = 'day-trade-item';
                    
                    const profitLossDisplay = trade.status === 'open' ? 
                        'Open' : 
                        `${trade.profitLoss >= 0 ? '+' : ''}$${trade.profitLoss.toFixed(2)}`;
                    
                    // Check if trade is multi-day
                    const isMultiDay = trade.entryDate && trade.date !== trade.entryDate;
                    
                    tradeEl.innerHTML = `
                        <div>
                            <div style="font-weight: 600;">${trade.pair} 
                                ${trade.status === 'open' ? '<span class="open-trade-badge">OPEN</span>' : ''}
                                ${isMultiDay ? '<span class="multi-day-badge">MULTI-DAY</span>' : ''}
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 5px; font-size: 14px; color: var(--neutral-color); flex-wrap: wrap;">
                                <span class="trade-type ${trade.type.toLowerCase()}">${trade.type}</span>
                                <span>$${trade.amount.toFixed(2)}</span>
                                <span class="${trade.status === 'closed' ? (trade.profitLoss >= 0 ? 'positive' : 'negative') : ''}" style="font-weight: 600;">
                                    ${profitLossDisplay}
                                </span>
                            </div>
                            <div style="font-size: 12px; color: var(--neutral-color); margin-top: 5px;">
                                Entry: ${formatTime(trade.entryTime)} 
                                ${trade.closeTime ? `- Close: ${formatTime(trade.closeTime)}` : ''}
                                ${isMultiDay ? `<br><small>Started: ${trade.entryDate}</small>` : ''}
                            </div>
                        </div>
                        <div class="day-trade-actions">
                            <button class="action-btn edit-btn" data-id="${trade.id}">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="action-btn delete-btn" data-id="${trade.id}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    `;
                    
                    dayTradesList.appendChild(tradeEl);
                });
                
                // Add event listeners to edit and delete buttons
                dayTradesList.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const tradeId = parseInt(this.getAttribute('data-id'));
                        closeDayTradesModal();
                        openEditTradeModal(tradeId);
                    });
                });
                
                dayTradesList.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const tradeId = parseInt(this.getAttribute('data-id'));
                        deleteTrade(tradeId);
                    });
                });
            }
            
            dayTradesModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function closeDayTradesModal() {
            dayTradesModal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        function openSettingsModal() {
            initialBalanceInput.value = settings.initialBalance;
            darkModeToggle.checked = settings.darkMode;
            importStatus.textContent = '';
            
            // Render the trades management list
            renderTradesManagementList();
            
            settingsModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function closeSettingsModal() {
            settingsModal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        function saveBalance() {
            const balance = parseFloat(initialBalanceInput.value);
            if (!isNaN(balance) && balance >= 0) {
                settings.initialBalance = balance;
                localStorage.setItem('tradeTrackerSettings', JSON.stringify(settings));
                updateStats();
                updateBalanceChart();
                closeSettingsModal();
            } else {
                alert('Please enter a valid balance amount.');
            }
        }
        
        function toggleDarkMode() {
            settings.darkMode = darkModeToggle.checked;
            localStorage.setItem('tradeTrackerSettings', JSON.stringify(settings));
            
            if (settings.darkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            
            // Update chart colors for dark mode
            updateBalanceChart();
        }
        
        function updateBalanceChart() {
            // Prepare data for the chart
            const sortedTrades = [...trades]
                .filter(trade => trade.status === 'closed')
                .sort((a, b) => new Date(a.closeTime || a.entryTime) - new Date(b.closeTime || b.entryTime));
            
            let balanceData = [settings.initialBalance];
            let labels = ['Initial'];
            
            let runningBalance = settings.initialBalance;
            
            sortedTrades.forEach(trade => {
                runningBalance += trade.profitLoss;
                balanceData.push(runningBalance);
                const tradeDate = trade.closeTime ? new Date(trade.closeTime) : new Date(trade.entryTime);
                // Use short month names for labels (e.g., "Sept 20")
                const monthName = getShortMonthName(tradeDate.getMonth());
                const day = tradeDate.getDate();
                labels.push(`${monthName} ${day}`);
            });
            
            // Get chart colors based on theme
            const textColor = getComputedStyle(document.body).getPropertyValue('--text-color');
            const gridColor = getComputedStyle(document.body).getPropertyValue('--border-color');
            const profitColor = getComputedStyle(document.body).getPropertyValue('--profit-color');
            
            // Destroy existing chart if it exists
            if (balanceChart) {
                balanceChart.destroy();
            }
            
            // Create new chart
            const ctx = balanceChartCanvas.getContext('2d');
            balanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Account Balance',
                        data: balanceData,
                        borderColor: profitColor,
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointBackgroundColor: profitColor,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 10,
                            right: 10,
                            bottom: 10,
                            left: 10
                        }
                    },
                    plugins: {
                        legend: {
                            display: false,
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: profitColor,
                            borderWidth: 1,
                            cornerRadius: 6,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return `Balance: $${context.parsed.y.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: textColor,
                                maxTicksLimit: window.innerWidth < 768 ? 5 : 8,
                                font: {
                                    size: window.innerWidth < 768 ? 10 : 12
                                }
                            },
                            grid: {
                                color: gridColor,
                                drawBorder: false
                            }
                        },
                        y: {
                            beginAtZero: false,
                            ticks: {
                                color: textColor,
                                font: {
                                    size: window.innerWidth < 768 ? 10 : 12
                                },
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return '$' + (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return '$' + (value / 1000).toFixed(1) + 'K';
                                    }
                                    return '$' + value.toLocaleString();
                                }
                            },
                            grid: {
                                color: gridColor,
                                drawBorder: false
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    },
                    elements: {
                        line: {
                            tension: 0.4
                        }
                    }
                }
            });
        }
        
        function exportToExcel() {
            if (trades.length === 0) {
                alert('No trades to export.');
                return;
            }
            
            // Prepare data for export
            const exportData = trades.map(trade => ({
                'Trade ID': trade.id,
                'Pair': trade.pair,
                'Type': trade.type,
                'Amount Risked': trade.amount,
                'Entry Time': trade.entryTime,
                'Close Time': trade.closeTime || 'Open',
                'Profit/Loss': trade.profitLoss || 'Open',
                'Status': trade.status,
                'Entry Date': trade.entryDate,
                'Display Date': trade.date
            }));
            
            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(exportData);
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Trades');
            
            // Generate Excel file and trigger download
            const fileName = `TradeJournal_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
        
        function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            importStatus.textContent = 'Importing...';
            importStatus.style.color = 'var(--neutral-color)';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Get first worksheet
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (jsonData.length === 0) {
                        importStatus.textContent = 'No data found in file.';
                        importStatus.style.color = 'var(--loss-color)';
                        return;
                    }
                    
                    let importedCount = 0;
                    let skippedCount = 0;
                    
                    jsonData.forEach(row => {
                        // Validate required fields
                        if (!row.Pair || !row.Type || row['Amount Risked'] === undefined) {
                            skippedCount++;
                            return;
                        }
                        
                        // Determine if trade is closed or open
                        const hasCloseTime = row['Close Time'] && row['Close Time'] !== 'Open';
                        const hasProfitLoss = row['Profit/Loss'] !== undefined && row['Profit/Loss'] !== 'Open';
                        const status = hasCloseTime && hasProfitLoss ? 'closed' : 'open';
                        
                        // Use display date if available, otherwise use close date or entry date
                        let displayDate;
                        if (row['Display Date']) {
                            displayDate = row['Display Date'];
                        } else if (hasCloseTime) {
                            displayDate = new Date(row['Close Time']).toISOString().split('T')[0];
                        } else {
                            displayDate = new Date(row['Entry Time']).toISOString().split('T')[0];
                        }
                        
                        const trade = {
                            id: trades.length > 0 ? Math.max(...trades.map(t => t.id)) + 1 : 1,
                            pair: row.Pair,
                            type: row.Type,
                            amount: parseFloat(row['Amount Risked']),
                            entryTime: row['Entry Time'],
                            closeTime: hasCloseTime ? row['Close Time'] : '',
                            profitLoss: hasProfitLoss ? parseFloat(row['Profit/Loss']) : null,
                            date: displayDate,
                            entryDate: new Date(row['Entry Time']).toISOString().split('T')[0],
                            status: status
                        };
                        
                        trades.push(trade);
                        importedCount++;
                    });
                    
                    // Save to localStorage
                    localStorage.setItem('tradeTrackerTrades', JSON.stringify(trades));
                    
                    // Update UI
                    renderCalendar();
                    updateStats();
                    renderRecentTrades();
                    updateBalanceChart();
                    updateMonthlyAnalysis();
                    
                    importStatus.textContent = `Successfully imported ${importedCount} trades. ${skippedCount} rows skipped.`;
                    importStatus.style.color = 'var(--profit-color)';
                    
                    // Reset file input
                    importExcelInput.value = '';
                    
                } catch (error) {
                    console.error('Import error:', error);
                    importStatus.textContent = 'Error importing file. Please check the format.';
                    importStatus.style.color = 'var(--loss-color)';
                }
            };
            
            reader.onerror = function() {
                importStatus.textContent = 'Error reading file.';
                importStatus.style.color = 'var(--loss-color)';
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // Bulk Delete Functions
        function renderTradesManagementList() {
            tradesManagementList.innerHTML = '';
            selectedTradeIds.clear();
            updateSelectedCount();
            
            if (trades.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'no-trades-message';
                emptyState.textContent = 'No trades to manage';
                tradesManagementList.appendChild(emptyState);
                return;
            }
            
            // Sort trades by date (newest first)
            const sortedTrades = [...trades].sort((a, b) => {
                const dateA = a.status === 'closed' && a.closeTime ? new Date(a.closeTime) : new Date(a.entryTime);
                const dateB = b.status === 'closed' && b.closeTime ? new Date(b.closeTime) : new Date(b.entryTime);
                return dateB - dateA;
            });
            
            sortedTrades.forEach(trade => {
                const tradeItem = document.createElement('div');
                tradeItem.className = 'trade-management-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = trade.id;
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        selectedTradeIds.add(trade.id);
                    } else {
                        selectedTradeIds.delete(trade.id);
                    }
                    updateSelectedCount();
                    updateSelectAllCheckbox();
                });
                
                const tradeInfo = document.createElement('div');
                tradeInfo.className = 'trade-management-info';
                
                const pairEl = document.createElement('span');
                pairEl.className = 'trade-management-pair';
                pairEl.textContent = trade.pair;
                
                const typeEl = document.createElement('span');
                typeEl.className = `trade-type ${trade.type.toLowerCase()}`;
                typeEl.textContent = trade.type;
                
                const dateEl = document.createElement('span');
                dateEl.className = 'trade-management-date';
                const tradeDate = trade.status === 'closed' && trade.closeTime ? 
                    new Date(trade.closeTime) : new Date(trade.entryTime);
                dateEl.textContent = tradeDate.toLocaleDateString();
                
                const statusEl = document.createElement('span');
                if (trade.status === 'open') {
                    statusEl.className = 'open-trade-badge';
                    statusEl.textContent = 'OPEN';
                }
                
                const profitEl = document.createElement('span');
                profitEl.className = `trade-management-profit ${trade.status === 'closed' ? (trade.profitLoss >= 0 ? 'positive' : 'negative') : ''}`;
                profitEl.textContent = trade.status === 'open' ? 
                    'Open' : 
                    `${trade.profitLoss >= 0 ? '+' : ''}$${trade.profitLoss.toFixed(2)}`;
                
                tradeInfo.appendChild(pairEl);
                tradeInfo.appendChild(typeEl);
                tradeInfo.appendChild(dateEl);
                tradeInfo.appendChild(statusEl);
                tradeInfo.appendChild(profitEl);
                
                tradeItem.appendChild(checkbox);
                tradeItem.appendChild(tradeInfo);
                
                tradesManagementList.appendChild(tradeItem);
            });
        }
        
        function selectAllTrades() {
            selectedTradeIds.clear();
            trades.forEach(trade => {
                selectedTradeIds.add(trade.id);
            });
            updateSelectedCount();
            updateCheckboxes();
        }
        
        function deselectAllTrades() {
            selectedTradeIds.clear();
            updateSelectedCount();
            updateCheckboxes();
        }
        
        function deleteSelectedTrades() {
            if (selectedTradeIds.size === 0) {
                alert('Please select at least one trade to delete.');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${selectedTradeIds.size} selected trade(s)? This action cannot be undone.`)) {
                trades = trades.filter(trade => !selectedTradeIds.has(trade.id));
                
                // Save to localStorage
                localStorage.setItem('tradeTrackerTrades', JSON.stringify(trades));
                
                // Clear selection
                selectedTradeIds.clear();
                updateSelectedCount();
                
                // Update UI
                renderCalendar();
                updateStats();
                renderRecentTrades();
                updateBalanceChart();
                updateMonthlyAnalysis();
                renderTradesManagementList();
                
                alert(`Successfully deleted ${selectedTradeIds.size} trade(s).`);
            }
        }
        
        function deleteAllTrades() {
            if (trades.length === 0) {
                alert('No trades to delete.');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ALL ${trades.length} trades? This action cannot be undone.`)) {
                trades = [];
                
                // Save to localStorage
                localStorage.setItem('tradeTrackerTrades', JSON.stringify(trades));
                
                // Clear selection
                selectedTradeIds.clear();
                updateSelectedCount();
                
                // Update UI
                renderCalendar();
                updateStats();
                renderRecentTrades();
                updateBalanceChart();
                updateMonthlyAnalysis();
                renderTradesManagementList();
                
                alert('All trades have been deleted.');
            }
        }
        
        function toggleSelectAll() {
            if (selectAllCheckbox.checked) {
                selectAllTrades();
            } else {
                deselectAllTrades();
            }
        }
        
        function updateSelectedCount() {
            selectedCountEl.textContent = `${selectedTradeIds.size} selected`;
        }
        
        function updateCheckboxes() {
            const checkboxes = tradesManagementList.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectedTradeIds.has(parseInt(checkbox.value));
            });
            updateSelectAllCheckbox();
        }
        
        function updateSelectAllCheckbox() {
            const allSelected = trades.length > 0 && selectedTradeIds.size === trades.length;
            const someSelected = selectedTradeIds.size > 0 && selectedTradeIds.size < trades.length;
            
            selectAllCheckbox.checked = allSelected;
            selectAllCheckbox.indeterminate = someSelected;
        }
        
        // Utility functions
        function formatTime(dateTimeStr) {
            if (!dateTimeStr) return '';
            const date = new Date(dateTimeStr);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        // Close modals when clicking outside of them
        window.addEventListener('click', function(e) {
            if (e.target === tradeModal) {
                closeModal();
            }
            if (e.target === dayTradesModal) {
                closeDayTradesModal();
            }
            if (e.target === settingsModal) {
                closeSettingsModal();
            }
        });
        
        // Handle window resize for better mobile experience
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                if (balanceChart) {
                    balanceChart.destroy();
                    updateBalanceChart();
                }
            }, 250);
        });
    </script>
</body>
</html>
